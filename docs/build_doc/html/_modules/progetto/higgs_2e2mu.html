

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>progetto.higgs_2e2mu &mdash; Higgs 2e2mu - CMEPDA Project  documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home" alt="Documentation Home"> Higgs 2e2mu - CMEPDA Project
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">progetto</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../readme.html">README</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Higgs 2e2mu - CMEPDA Project</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>progetto.higgs_2e2mu</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for progetto.higgs_2e2mu</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Project for the CMEPDA exam.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>

<span class="kn">import</span> <span class="nn">ROOT</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="kn">from</span> <span class="nn">sklearn.utils</span> <span class="kn">import</span> <span class="n">shuffle</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">StandardScaler</span>
<span class="kn">from</span> <span class="nn">sklearn.decomposition</span> <span class="kn">import</span> <span class="n">PCA</span>
<span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">RandomForestClassifier</span><span class="p">,</span> <span class="n">AdaBoostClassifier</span>
<span class="kn">from</span> <span class="nn">sklearn.neural_network</span> <span class="kn">import</span> <span class="n">MLPClassifier</span>
<span class="kn">from</span> <span class="nn">sklearn.tree</span> <span class="kn">import</span> <span class="n">DecisionTreeClassifier</span>
<span class="kn">from</span> <span class="nn">sklearn.svm</span> <span class="kn">import</span> <span class="n">SVC</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">roc_curve</span><span class="p">,</span> <span class="n">auc</span>
<span class="kn">import</span> <span class="nn">joblib</span>

<span class="kn">from</span> <span class="nn">tensorflow.keras.models</span> <span class="kn">import</span> <span class="n">Sequential</span><span class="p">,</span> <span class="n">load_model</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.layers</span> <span class="kn">import</span> <span class="n">Dense</span><span class="p">,</span> <span class="n">Dropout</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.regularizers</span> <span class="kn">import</span> <span class="n">l2</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.optimizers</span> <span class="kn">import</span> <span class="n">SGD</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.utils</span> <span class="kn">import</span> <span class="n">to_categorical</span><span class="p">,</span> <span class="n">plot_model</span>

<span class="c1">#Necessary option in order for argparse to function, if not present ROOT will</span>
<span class="c1">#prevail over argparse when option are passed from command line</span>
<span class="c1"># ROOT.PyConfig.IgnoreCommandLineOptions = True</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;higgs_2e2mu&#39;</span><span class="p">)</span>
<span class="c1"># The log file is in &quot;write&quot; mode, to return to &quot;append&quot; mode change w with a</span>
<span class="n">hdlr</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">FileHandler</span><span class="p">(</span><span class="s1">&#39;higgs_2e2mu.log&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
<span class="n">formatter</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1"> </span><span class="si">%(levelname)s</span><span class="s1"> </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">hdlr</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">formatter</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">hdlr</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>

<span class="n">_description</span> <span class="o">=</span> <span class="s2">&quot;The program will perform standard analysis if no option is given.&quot;</span>

<span class="c1">#Include cpp library for RDataFrame modules</span>
<span class="n">ROOT</span><span class="o">.</span><span class="n">gInterpreter</span><span class="o">.</span><span class="n">ProcessLine</span><span class="p">(</span><span class="s1">&#39;#include &quot;library.h&quot;&#39;</span><span class="p">)</span>

<span class="c1"># Enable multi-threading</span>
<span class="c1"># ROOT.ROOT.EnableImplicitMT(4)</span>
<span class="n">base_url</span> <span class="o">=</span> <span class="s2">&quot;root://eospublic.cern.ch//eos/root-eos/cms_opendata_2012_nanoaod/&quot;</span>
<span class="c1">#Imput links to signal, background and data samples</span>
<span class="c1">#Signal of Higgs -&gt; 4 leptons</span>
<span class="n">link_sig</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">base_url</span><span class="p">,</span> <span class="s2">&quot;SMHiggsToZZTo4L.root&quot;</span><span class="p">])</span>
<span class="c1">#Background of ZZ -&gt; 4 leptons</span>
<span class="n">link_bkg</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">base_url</span><span class="p">,</span> <span class="s2">&quot;ZZTo2e2mu.root&quot;</span><span class="p">])</span>
<span class="c1">#CMS data tacken in 2012 (11.6 fb^(-1) integrated luminosity)</span>
<span class="n">link_data</span> <span class="o">=</span> <span class="n">ROOT</span><span class="o">.</span><span class="n">std</span><span class="o">.</span><span class="n">vector</span><span class="p">(</span><span class="s2">&quot;string&quot;</span><span class="p">)(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">link_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">base_url</span><span class="p">,</span> <span class="s2">&quot;Run2012B_DoubleMuParked.root&quot;</span><span class="p">])</span>
<span class="n">link_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">base_url</span><span class="p">,</span> <span class="s2">&quot;Run2012C_DoubleMuParked.root&quot;</span><span class="p">])</span>
<span class="c1">#Dict of link</span>
<span class="n">dataset_link</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;signal&quot;</span><span class="p">:</span> <span class="n">link_sig</span><span class="p">,</span> <span class="s2">&quot;background&quot;</span><span class="p">:</span> <span class="n">link_bkg</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="n">link_data</span><span class="p">}</span>

<div class="viewcode-block" id="style"><a class="viewcode-back" href="../../progetto.html#progetto.higgs_2e2mu.style">[docs]</a><span class="k">def</span> <span class="nf">style</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">Rcolor</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Set the basic style of a given histogram depending on which mode</span>
<span class="sd">    is required. (Lazy)</span>

<span class="sd">    Args:</span>
<span class="sd">        h (TH1D): Root histogram to style.</span>
<span class="sd">        mode (str): &quot;e&quot; for empty style, &quot;f&quot; for filled style,</span>
<span class="sd">                       &quot;m&quot; for marker style.</span>

<span class="sd">        Rcolor (Tcolor): Root color to apply.</span>

<span class="sd">    Returns:</span>
<span class="sd">        TH1D: styled histogram</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ROOT</span><span class="o">.</span><span class="n">gStyle</span><span class="o">.</span><span class="n">SetOptStat</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">ROOT</span><span class="o">.</span><span class="n">gStyle</span><span class="o">.</span><span class="n">SetOptTitle</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">ROOT</span><span class="o">.</span><span class="n">gStyle</span><span class="o">.</span><span class="n">SetTextFont</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
    <span class="n">h</span><span class="o">.</span><span class="n">SetStats</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">h</span><span class="o">.</span><span class="n">SetLineStyle</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">h</span><span class="o">.</span><span class="n">SetLineWidth</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">h</span><span class="o">.</span><span class="n">GetYaxis</span><span class="p">()</span><span class="o">.</span><span class="n">SetTitle</span><span class="p">(</span><span class="s2">&quot;Counts&quot;</span><span class="p">)</span>

    <span class="c1">#empty histogram</span>
    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;e&quot;</span><span class="p">:</span>
        <span class="n">h</span><span class="o">.</span><span class="n">SetLineColor</span><span class="p">(</span><span class="n">Rcolor</span><span class="p">)</span>
        <span class="n">h</span><span class="o">.</span><span class="n">SetLineWidth</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

    <span class="c1">#full histogram</span>
    <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;f&quot;</span><span class="p">:</span>
        <span class="n">h</span><span class="o">.</span><span class="n">SetFillStyle</span><span class="p">(</span><span class="mi">1001</span><span class="p">)</span>
        <span class="n">h</span><span class="o">.</span><span class="n">SetFillColor</span><span class="p">(</span><span class="n">Rcolor</span><span class="p">)</span>
        <span class="n">h</span><span class="o">.</span><span class="n">SetLineColor</span><span class="p">(</span><span class="n">ROOT</span><span class="o">.</span><span class="n">kBlack</span><span class="p">)</span>

    <span class="c1">#mark histogram</span>
    <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;m&quot;</span><span class="p">:</span>
        <span class="n">h</span><span class="o">.</span><span class="n">SetMarkerStyle</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
        <span class="n">h</span><span class="o">.</span><span class="n">SetMarkerSize</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
        <span class="n">h</span><span class="o">.</span><span class="n">SetMarkerColor</span><span class="p">(</span><span class="n">Rcolor</span><span class="p">)</span>
        <span class="n">h</span><span class="o">.</span><span class="n">SetLineColor</span><span class="p">(</span><span class="n">Rcolor</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">h</span></div>

<div class="viewcode-block" id="snapshot"><a class="viewcode-back" href="../../progetto.html#progetto.higgs_2e2mu.snapshot">[docs]</a><span class="k">def</span> <span class="nf">snapshot</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Make a snapshot of RDataFrame to local file. (Lazy)</span>

<span class="sd">    Args:</span>
<span class="sd">        df (RDataFrame): RDF to save.</span>
<span class="sd">        filename (str): name of the file to save</span>

<span class="sd">    Returns:</span>
<span class="sd">        RDataFrame: same RDF as input.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">snapshotOptions</span> <span class="o">=</span> <span class="n">ROOT</span><span class="o">.</span><span class="n">RDF</span><span class="o">.</span><span class="n">RSnapshotOptions</span><span class="p">()</span>
    <span class="n">snapshotOptions</span><span class="o">.</span><span class="n">fLazy</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="c1"># Former version selected only requested columns but there is a problem</span>
    <span class="c1"># in ROOT with some columns name that raise an error.</span>
    <span class="c1"># To avoid it, all columns are selected instead.</span>
    <span class="c1"># columns = ROOT.vector(&quot;string&quot;)()</span>
    <span class="c1"># for branch in branches_list:</span>
    <span class="c1">#     columns.push_back(branch)</span>
    <span class="c1"># df_out = df.Snapshot(&quot;Events&quot;, filename, columns, snapshotOptions)</span>
    <span class="n">df_out</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">Snapshot</span><span class="p">(</span><span class="s2">&quot;Events&quot;</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">snapshotOptions</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df_out</span></div>

<div class="viewcode-block" id="df_prefilter"><a class="viewcode-back" href="../../progetto.html#progetto.higgs_2e2mu.df_prefilter">[docs]</a><span class="k">def</span> <span class="nf">df_prefilter</span><span class="p">(</span><span class="n">df_key</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Prefilter RDF selecting events with 2 or more electrons and</span>
<span class="sd">    2 or more muons.</span>

<span class="sd">    Args:</span>
<span class="sd">        df_key (str): key to access global dataset_link dictionary</span>
<span class="sd">                         containing the chosen dataset (e.g. &quot;signal&quot;).</span>

<span class="sd">    Returns:</span>
<span class="sd">        RDataFrame: Filtered RDF of chosen dataset.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># In this analysis we will consider only events with 2 or more</span>
    <span class="c1"># electrons and muons</span>
    <span class="n">df_net</span> <span class="o">=</span> <span class="n">ROOT</span><span class="o">.</span><span class="n">RDataFrame</span><span class="p">(</span><span class="s2">&quot;Events&quot;</span><span class="p">,</span> <span class="n">dataset_link</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">df_key</span><span class="p">))</span>
    <span class="n">df_2e2m</span> <span class="o">=</span> <span class="n">df_net</span><span class="o">.</span><span class="n">Filter</span><span class="p">(</span><span class="s2">&quot;nElectron&gt;=2 &amp;&amp; nMuon&gt;=2&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;Events with at least two Electrons and Muons&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df_2e2m</span></div>

<div class="viewcode-block" id="access_df"><a class="viewcode-back" href="../../progetto.html#progetto.higgs_2e2mu.access_df">[docs]</a><span class="k">def</span> <span class="nf">access_df</span><span class="p">(</span><span class="n">df_key</span><span class="p">,</span> <span class="n">local_flag</span><span class="p">,</span> <span class="n">mode</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Access given dataset from appropriate location. Download to local</span>
<span class="sd">    file if needed. (Lazy)</span>

<span class="sd">    Args:</span>
<span class="sd">        df_key (str): label of the chosen dataset</span>
<span class="sd">                         (&quot;signal&quot;, &quot;background&quot; or &quot;data&quot;).</span>
<span class="sd">        local_flag (bool): boolean flag to save local file or not.</span>
<span class="sd">        mode (str): tag to identify preliminar or standard analysis</span>
<span class="sd">                    (&quot;p&quot; or &quot;std&quot;)</span>

<span class="sd">    Returns:</span>
<span class="sd">        RDataFrame: requested RDF</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">local_flag</span><span class="p">:</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">df_key</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">mode</span><span class="si">}</span><span class="s2">.root&quot;</span>
        <span class="c1"># Try/except method difficult to use because ROOT exceptions are not easily</span>
        <span class="c1"># catched by python</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
            <span class="n">df_local</span> <span class="o">=</span> <span class="n">ROOT</span><span class="o">.</span><span class="n">RDataFrame</span><span class="p">(</span><span class="s2">&quot;Events&quot;</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
            <span class="n">df_out</span> <span class="o">=</span> <span class="n">df_local</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Problem loading local df:</span><span class="si">{</span><span class="n">df_key</span><span class="si">}</span><span class="s2">.</span><span class="se">\n</span><span class="s2"> Starting download&quot;</span><span class="p">)</span>
            <span class="n">df_2e2m</span> <span class="o">=</span> <span class="n">df_prefilter</span><span class="p">(</span><span class="n">df_key</span><span class="p">)</span>
            <span class="n">df_out</span> <span class="o">=</span> <span class="n">snapshot</span><span class="p">(</span><span class="n">df_2e2m</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">df_out</span> <span class="o">=</span> <span class="n">df_prefilter</span><span class="p">(</span><span class="n">df_key</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df_out</span></div>

<div class="viewcode-block" id="preliminar_request"><a class="viewcode-back" href="../../progetto.html#progetto.higgs_2e2mu.preliminar_request">[docs]</a><span class="k">def</span> <span class="nf">preliminar_request</span><span class="p">(</span><span class="n">flag</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;First look at the chosen input file. (Lazy)</span>

<span class="sd">    Prompt the user to select dataset and branche(s) to preview.</span>

<span class="sd">    This function is meant to explore only first hand characteristics of</span>
<span class="sd">    events and by default it will show three variables reconstructed</span>
<span class="sd">    form the components present in datasets.</span>

<span class="sd">    Prepare histograms of chosen data.</span>

<span class="sd">    Args:</span>
<span class="sd">        flag (bool): boolean flag to save local file or not.</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: key to access the dataset (e.g. &quot;signal&quot;).</span>
<span class="sd">        list: selected branches list.</span>
<span class="sd">        list: selected THisto1D list.</span>

<span class="sd">    Raises: key error if user insert an invalid key.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">df_key</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Insert the data frame you want to look at first &quot;</span>
                   <span class="sa">f</span><span class="s2">&quot;choosing from this list:</span><span class="se">\n</span><span class="si">{</span><span class="n">dataset_link</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1">#3D reconstruction of some fundamental variables and its Histograms</span>
        <span class="n">df_In</span> <span class="o">=</span> <span class="n">access_df</span><span class="p">(</span><span class="n">df_key</span><span class="p">,</span> <span class="n">flag</span><span class="p">,</span> <span class="s2">&quot;p&quot;</span><span class="p">)</span>
        <span class="c1"># These are the default branches that are reconstructed regardless the input given</span>
        <span class="n">df_In3d</span> <span class="o">=</span> <span class="n">df_In</span><span class="o">.</span><span class="n">Define</span><span class="p">(</span><span class="s2">&quot;PV_3d&quot;</span><span class="p">,</span> <span class="s2">&quot;sqrt(PV_x*PV_x + PV_y*PV_y + PV_z*PV_z)&quot;</span><span class="p">)</span>\
                       <span class="o">.</span><span class="n">Define</span><span class="p">(</span><span class="s2">&quot;Muon_ip3d&quot;</span><span class="p">,</span> <span class="s2">&quot;sqrt(Muon_dxy*Muon_dxy + Muon_dz*Muon_dz)&quot;</span><span class="p">)</span>\
                       <span class="o">.</span><span class="n">Define</span><span class="p">(</span><span class="s2">&quot;El_ip3d&quot;</span><span class="p">,</span> <span class="s2">&quot;sqrt(Electron_dxy*Electron_dxy + Electron_dz*Electron_dz)&quot;</span><span class="p">)</span>

        <span class="c1"># In this way nothing is saved locally but the original list of available</span>
        <span class="c1"># columns can be shown</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">access_df</span><span class="p">(</span><span class="n">df_key</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;p&quot;</span><span class="p">)</span>
        <span class="n">list_branches</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">GetColumnNames</span><span class="p">()</span>

        <span class="c1"># Decide which variables to look first</span>
        <span class="n">dictOfBranches</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span><span class="n">list_branches</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">list_branches</span><span class="p">))}</span>
        <span class="n">list_In</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Insert the variable numbers to look at, separated by a space&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;press return when you are done:</span><span class="se">\n</span><span class="si">{</span><span class="n">dictOfBranches</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Control input and retrieve the required branches</span>
        <span class="n">list_str</span> <span class="o">=</span> <span class="n">list_In</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
        <span class="n">b_In</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;PV_3d&quot;</span><span class="p">,</span> <span class="s2">&quot;Muon_ip3d&quot;</span><span class="p">,</span> <span class="s2">&quot;El_ip3d&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">list_str</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()</span> <span class="ow">and</span> <span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">:</span>
                <span class="n">current_branch</span> <span class="o">=</span> <span class="n">dictOfBranches</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span>
                <span class="n">b_In</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">current_branch</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error! </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> is an invalid key!&quot;</span><span class="p">)</span>

        <span class="c1"># Make sure that each branch is taken only once</span>
        <span class="n">unique_b_In</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">b_In</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;These are the chosen branches plus the default 3:</span><span class="si">{</span><span class="n">unique_b_In</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Request the histos</span>
        <span class="n">h_In</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">branch</span> <span class="ow">in</span> <span class="n">unique_b_In</span><span class="p">:</span>
            <span class="n">current_histo</span> <span class="o">=</span> <span class="n">df_In3d</span><span class="o">.</span><span class="n">Histo1D</span><span class="p">(</span><span class="n">branch</span><span class="p">)</span>
            <span class="n">h_In</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">current_histo</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cannot read the given key!</span><span class="se">\n</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df_key</span><span class="p">,</span> <span class="n">unique_b_In</span><span class="p">,</span> <span class="n">h_In</span></div>

<div class="viewcode-block" id="preliminar_plot"><a class="viewcode-back" href="../../progetto.html#progetto.higgs_2e2mu.preliminar_plot">[docs]</a><span class="k">def</span> <span class="nf">preliminar_plot</span><span class="p">(</span><span class="n">df_key</span><span class="p">,</span> <span class="n">branch_histo</span><span class="p">,</span> <span class="n">histo_data</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Plot preliminar analysis histograms of the selected dataset</span>
<span class="sd">    and branches.</span>
<span class="sd">    The histograms are saved both in a .pdf and in a .root file</span>
<span class="sd">    in order to be further investigated.</span>

<span class="sd">    Args:</span>
<span class="sd">        df_key (str): selected dataset name.</span>
<span class="sd">        branch_histo (list): list of selected branches.</span>
<span class="sd">        histo_data (TH1D): histogram of given dataset and branches.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># General Canvas Settings</span>
    <span class="n">ROOT</span><span class="o">.</span><span class="n">gStyle</span><span class="o">.</span><span class="n">SetOptStat</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">ROOT</span><span class="o">.</span><span class="n">gStyle</span><span class="o">.</span><span class="n">SetTextFont</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
    <span class="n">c_histo</span> <span class="o">=</span> <span class="n">ROOT</span><span class="o">.</span><span class="n">TCanvas</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;c_histo_</span><span class="si">{</span><span class="n">branch_histo</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="mi">800</span><span class="p">,</span> <span class="mi">700</span><span class="p">)</span>
    <span class="n">c_histo</span><span class="o">.</span><span class="n">cd</span><span class="p">()</span>

    <span class="c1"># Set and Draw histogram for data points</span>
    <span class="n">x_max</span> <span class="o">=</span> <span class="n">histo_data</span><span class="o">.</span><span class="n">GetXaxis</span><span class="p">()</span><span class="o">.</span><span class="n">GetXmax</span><span class="p">()</span>
    <span class="n">x_min</span> <span class="o">=</span> <span class="n">histo_data</span><span class="o">.</span><span class="n">GetXaxis</span><span class="p">()</span><span class="o">.</span><span class="n">GetXmin</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;One day minumun and maximun of the </span><span class="si">{</span><span class="n">branch_histo</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot; will be useful...but it is NOT This day!</span><span class="si">{</span><span class="n">x_max</span><span class="p">,</span><span class="n">x_min</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="c1"># histo_data.GetXaxis().SetRangeUser(x_min,x_max)</span>

    <span class="n">histo_data</span><span class="o">.</span><span class="n">SetLineStyle</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">histo_data</span><span class="o">.</span><span class="n">SetLineWidth</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">histo_data</span><span class="o">.</span><span class="n">SetLineColor</span><span class="p">(</span><span class="n">ROOT</span><span class="o">.</span><span class="n">kBlack</span><span class="p">)</span>
    <span class="n">histo_data</span><span class="o">.</span><span class="n">Draw</span><span class="p">()</span>

    <span class="c1"># Add Legend</span>
    <span class="n">legend</span> <span class="o">=</span> <span class="n">ROOT</span><span class="o">.</span><span class="n">TLegend</span><span class="p">(</span><span class="mf">0.7</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.85</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">)</span>
    <span class="n">legend</span><span class="o">.</span><span class="n">SetFillColor</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">legend</span><span class="o">.</span><span class="n">SetBorderSize</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">legend</span><span class="o">.</span><span class="n">SetLineWidth</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">legend</span><span class="o">.</span><span class="n">SetTextSize</span><span class="p">(</span><span class="mf">0.04</span><span class="p">)</span>
    <span class="n">legend</span><span class="o">.</span><span class="n">AddEntry</span><span class="p">(</span><span class="n">histo_data</span><span class="p">,</span> <span class="n">df_key</span><span class="p">)</span>
    <span class="n">legend</span><span class="o">.</span><span class="n">Draw</span><span class="p">()</span>

    <span class="c1">#Save plot</span>
    <span class="n">c_histo</span><span class="o">.</span><span class="n">SaveAs</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">branch_histo</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">df_key</span><span class="si">}</span><span class="s2">.pdf&quot;</span><span class="p">)</span>
    <span class="n">c_histo</span><span class="o">.</span><span class="n">SaveAs</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">branch_histo</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">df_key</span><span class="si">}</span><span class="s2">.root&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="preliminar_retrieve"><a class="viewcode-back" href="../../progetto.html#progetto.higgs_2e2mu.preliminar_retrieve">[docs]</a><span class="k">def</span> <span class="nf">preliminar_retrieve</span><span class="p">(</span><span class="n">df_key</span><span class="p">,</span> <span class="n">branches</span><span class="p">,</span> <span class="n">histos</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Retrieve and plot requested histograms. (Instant)</span>

<span class="sd">    Args:</span>
<span class="sd">        df_key (str): dataset key to access (e.g. &quot;signal&quot;).</span>
<span class="sd">        branches (list): list of branches to process.</span>
<span class="sd">        histos (list): list of THisto1D to draw and save.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Trigger event loop and plot</span>
    <span class="k">for</span> <span class="n">branch</span><span class="p">,</span> <span class="n">hist</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">branches</span><span class="p">,</span> <span class="n">histos</span><span class="p">):</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">hist</span><span class="o">.</span><span class="n">GetValue</span><span class="p">()</span>
        <span class="n">preliminar_plot</span><span class="p">(</span><span class="n">df_key</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">h</span><span class="p">)</span></div>

<div class="viewcode-block" id="standard_define"><a class="viewcode-back" href="../../progetto.html#progetto.higgs_2e2mu.standard_define">[docs]</a><span class="k">def</span> <span class="nf">standard_define</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Define and add to the input RDF the variables that</span>
<span class="sd">    will be used for filter events in the standard analysis. (Lazy)</span>

<span class="sd">    All the variables that are more significant for the analysis, such as</span>
<span class="sd">    Z, H and the angular variables are regrouped and defined in a</span>
<span class="sd">    specific function to make clearer the main points of the workflow</span>
<span class="sd">    and to be more easily accessible from the ML functions.</span>

<span class="sd">    Args:</span>
<span class="sd">        df (RDataFrame): RDF to add new variables to.</span>

<span class="sd">    Returns:</span>
<span class="sd">        RDataFrame: RDF with added variables.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">el_sip3d</span> <span class="o">=</span> <span class="s2">&quot;Electron_ip3d/sqrt(Electron_dxyErr*Electron_dxyErr+ Electron_dzErr*Electron_dzErr)&quot;</span>
    <span class="n">el_ip3d</span> <span class="o">=</span> <span class="s2">&quot;sqrt(Electron_dxy*Electron_dxy + Electron_dz*Electron_dz)&quot;</span>
    <span class="n">mu_ip3d</span> <span class="o">=</span> <span class="s2">&quot;sqrt(Muon_dxy*Muon_dxy + Muon_dz*Muon_dz)&quot;</span>
    <span class="n">mu_sip3d</span> <span class="o">=</span> <span class="s2">&quot;Muon_ip3d/sqrt(Muon_dxyErr*Muon_dxyErr + Muon_dzErr*Muon_dzErr)&quot;</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">Define</span><span class="p">(</span><span class="s2">&quot;Electron_ip3d&quot;</span><span class="p">,</span> <span class="n">el_ip3d</span><span class="p">)</span>\
           <span class="o">.</span><span class="n">Define</span><span class="p">(</span><span class="s2">&quot;Electron_sip3d&quot;</span><span class="p">,</span> <span class="n">el_sip3d</span><span class="p">)</span>\
           <span class="o">.</span><span class="n">Define</span><span class="p">(</span><span class="s2">&quot;Muon_ip3d&quot;</span><span class="p">,</span> <span class="n">mu_ip3d</span><span class="p">)</span>\
           <span class="o">.</span><span class="n">Define</span><span class="p">(</span><span class="s2">&quot;Muon_sip3d&quot;</span><span class="p">,</span> <span class="n">mu_sip3d</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">df</span></div>

<div class="viewcode-block" id="show_cut"><a class="viewcode-back" href="../../progetto.html#progetto.higgs_2e2mu.show_cut">[docs]</a><span class="k">def</span> <span class="nf">show_cut</span><span class="p">(</span><span class="n">df_2e2m</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Compare unfiltered and filtered data for each filter,</span>
<span class="sd">    considering the main cuts used in the analysis published on CERN Open Data.</span>

<span class="sd">    Args:</span>
<span class="sd">        df_2e2m (RDataFrame): RDF to be filtered.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: filters dictionary.</span>
<span class="sd">              The keys are the filters, the values are lists containing:</span>
<span class="sd">              unfiltered histos, filtered histos, filter RDF Reports.</span>
<span class="sd">              Each single filter contains the histograms of all the</span>
<span class="sd">              variables that define it.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#1st filter: Good isolation it&#39;s not symmetrical for electron and muon</span>
    <span class="n">h_unfil_eliso3</span> <span class="o">=</span> <span class="n">df_2e2m</span><span class="o">.</span><span class="n">Histo1D</span><span class="p">((</span><span class="s2">&quot;h_eliso3&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">),</span> <span class="s2">&quot;Electron_pfRelIso03_all&quot;</span><span class="p">)</span>
    <span class="n">h_unfil_muiso4</span> <span class="o">=</span> <span class="n">df_2e2m</span><span class="o">.</span><span class="n">Histo1D</span><span class="p">((</span><span class="s2">&quot;h_muiso4&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">),</span> <span class="s2">&quot;Muon_pfRelIso04_all&quot;</span><span class="p">)</span>

    <span class="n">df_eliso3</span> <span class="o">=</span> <span class="n">df_2e2m</span><span class="o">.</span><span class="n">Filter</span><span class="p">(</span><span class="s2">&quot;All(abs(Electron_pfRelIso03_all)&lt;0.40)&quot;</span><span class="p">,</span> <span class="s2">&quot;ElIso03 cut&quot;</span><span class="p">)</span>
    <span class="n">h_fil_eliso3</span> <span class="o">=</span> <span class="n">df_eliso3</span><span class="o">.</span><span class="n">Histo1D</span><span class="p">((</span><span class="s2">&quot;h_eliso3&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">),</span> <span class="s2">&quot;Electron_pfRelIso03_all&quot;</span><span class="p">)</span>
    <span class="n">df_muiso4</span> <span class="o">=</span> <span class="n">df_2e2m</span><span class="o">.</span><span class="n">Filter</span><span class="p">(</span><span class="s2">&quot;All(abs(Muon_pfRelIso04_all)&lt;0.40)&quot;</span><span class="p">,</span> <span class="s2">&quot;MuIso04 cut&quot;</span><span class="p">)</span>
    <span class="n">h_fil_muiso4</span> <span class="o">=</span> <span class="n">df_muiso4</span><span class="o">.</span><span class="n">Histo1D</span><span class="p">((</span><span class="s2">&quot;h_muiso4&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">),</span> <span class="s2">&quot;Muon_pfRelIso04_all&quot;</span><span class="p">)</span>

    <span class="n">filter_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Isolation&quot;</span><span class="p">:[[</span><span class="n">h_unfil_eliso3</span><span class="p">,</span> <span class="n">h_unfil_muiso4</span><span class="p">],</span>
                                <span class="p">[</span><span class="n">h_fil_eliso3</span><span class="p">,</span> <span class="n">h_fil_muiso4</span><span class="p">],</span>
                                <span class="p">[</span><span class="n">df_eliso3</span><span class="o">.</span><span class="n">Report</span><span class="p">(),</span> <span class="n">df_muiso4</span><span class="o">.</span><span class="n">Report</span><span class="p">()]],</span>
                   <span class="s2">&quot;Eta&quot;</span><span class="p">:[[],</span> <span class="p">[],</span> <span class="p">[]],</span> <span class="s2">&quot;Dr&quot;</span><span class="p">:[[],</span> <span class="p">[],</span> <span class="p">[]],</span> <span class="s2">&quot;Pt&quot;</span><span class="p">:[[],</span> <span class="p">[],</span> <span class="p">[]],</span>
                   <span class="s2">&quot;Electron_track&quot;</span><span class="p">:[[],</span> <span class="p">[],</span> <span class="p">[]],</span> <span class="s2">&quot;Muon_track&quot;</span><span class="p">:[[],</span> <span class="p">[],</span> <span class="p">[]],</span>
                   <span class="s2">&quot;Z_mass&quot;</span><span class="p">:[[],</span> <span class="p">[],</span> <span class="p">[]]}</span>

    <span class="c1"># Dataframe for filter in pt, it&#39;s symmetrical but involves mu and e at the same time</span>
    <span class="n">df_pt</span> <span class="o">=</span> <span class="n">df_2e2m</span><span class="o">.</span><span class="n">Filter</span><span class="p">(</span><span class="s2">&quot;pt_cut(Muon_pt, Electron_pt)&quot;</span><span class="p">,</span> <span class="s2">&quot;Pt cuts&quot;</span><span class="p">)</span>

    <span class="c1">#Filters that either are simmetrical or don&#39;t involve mu and e at the same time</span>
    <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;Electron&quot;</span><span class="p">,</span> <span class="s2">&quot;Muon&quot;</span><span class="p">]:</span>
        <span class="c1">#2nd filter:Eta cut</span>
        <span class="n">h_unfil_eta</span> <span class="o">=</span> <span class="n">df_2e2m</span><span class="o">.</span><span class="n">Histo1D</span><span class="p">((</span><span class="sa">f</span><span class="s2">&quot;h_</span><span class="si">{</span><span class="n">part</span><span class="si">}</span><span class="s2">_eta&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">part</span><span class="si">}</span><span class="s2">_eta&quot;</span><span class="p">)</span>
        <span class="n">df_eta</span> <span class="o">=</span> <span class="n">df_2e2m</span><span class="o">.</span><span class="n">Filter</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;All(abs(</span><span class="si">{</span><span class="n">part</span><span class="si">}</span><span class="s2">_eta)&lt;2.5)&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">part</span><span class="si">}</span><span class="s2">_Eta cut&quot;</span><span class="p">)</span>
        <span class="n">h_fil_eta</span> <span class="o">=</span> <span class="n">df_eta</span><span class="o">.</span><span class="n">Histo1D</span><span class="p">((</span><span class="sa">f</span><span class="s2">&quot;h_</span><span class="si">{</span><span class="n">part</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">part</span><span class="si">}</span><span class="s2">_eta&quot;</span><span class="p">)</span>
        <span class="n">filter_dict</span><span class="p">[</span><span class="s2">&quot;Eta&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">h_unfil_eta</span><span class="p">)</span>
        <span class="n">filter_dict</span><span class="p">[</span><span class="s2">&quot;Eta&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">h_fil_eta</span><span class="p">)</span>
        <span class="n">filter_dict</span><span class="p">[</span><span class="s2">&quot;Eta&quot;</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_eta</span><span class="o">.</span><span class="n">Report</span><span class="p">())</span>
        <span class="c1">#3rd filter:Dr cut</span>
        <span class="n">df_dr</span> <span class="o">=</span> <span class="n">df_2e2m</span><span class="o">.</span><span class="n">Define</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">part</span><span class="si">}</span><span class="s2">_dr&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;dr_def(</span><span class="si">{</span><span class="n">part</span><span class="si">}</span><span class="s2">_eta, </span><span class="si">{</span><span class="n">part</span><span class="si">}</span><span class="s2">_phi)&quot;</span><span class="p">)</span>
        <span class="n">h_unfil_dr</span> <span class="o">=</span> <span class="n">df_dr</span><span class="o">.</span><span class="n">Histo1D</span><span class="p">((</span><span class="sa">f</span><span class="s2">&quot;h_</span><span class="si">{</span><span class="n">part</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">5.5</span><span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">part</span><span class="si">}</span><span class="s2">_dr&quot;</span><span class="p">)</span>
        <span class="n">df_fil_dr</span> <span class="o">=</span> <span class="n">df_dr</span><span class="o">.</span><span class="n">Filter</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">part</span><span class="si">}</span><span class="s2">_dr&gt;=0.02&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">part</span><span class="si">}</span><span class="s2">_Dr cut&quot;</span><span class="p">)</span>
        <span class="n">h_fil_dr</span> <span class="o">=</span> <span class="n">df_fil_dr</span><span class="o">.</span><span class="n">Histo1D</span><span class="p">((</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">part</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">part</span><span class="si">}</span><span class="s2">_dr&quot;</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">5.5</span><span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">part</span><span class="si">}</span><span class="s2">_dr&quot;</span><span class="p">)</span>
        <span class="n">filter_dict</span><span class="p">[</span><span class="s2">&quot;Dr&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">h_unfil_dr</span><span class="p">)</span>
        <span class="n">filter_dict</span><span class="p">[</span><span class="s2">&quot;Dr&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">h_fil_dr</span><span class="p">)</span>
        <span class="n">filter_dict</span><span class="p">[</span><span class="s2">&quot;Dr&quot;</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_fil_dr</span><span class="o">.</span><span class="n">Report</span><span class="p">())</span>
        <span class="c1">#4th filter:Pt cut</span>
        <span class="n">h_unfil_pt</span> <span class="o">=</span> <span class="n">df_2e2m</span><span class="o">.</span><span class="n">Histo1D</span><span class="p">((</span><span class="sa">f</span><span class="s2">&quot;h_</span><span class="si">{</span><span class="n">part</span><span class="si">}</span><span class="s2">pt&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">120</span><span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">part</span><span class="si">}</span><span class="s2">_pt&quot;</span><span class="p">)</span>
        <span class="n">h_fil_pt</span> <span class="o">=</span> <span class="n">df_pt</span><span class="o">.</span><span class="n">Histo1D</span><span class="p">((</span><span class="sa">f</span><span class="s2">&quot;h_</span><span class="si">{</span><span class="n">part</span><span class="si">}</span><span class="s2">_pt&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">120</span><span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">part</span><span class="si">}</span><span class="s2">_pt&quot;</span><span class="p">)</span>
        <span class="n">filter_dict</span><span class="p">[</span><span class="s2">&quot;Pt&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">h_unfil_pt</span><span class="p">)</span>
        <span class="n">filter_dict</span><span class="p">[</span><span class="s2">&quot;Pt&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">h_fil_pt</span><span class="p">)</span>
        <span class="n">filter_dict</span><span class="p">[</span><span class="s2">&quot;Pt&quot;</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_pt</span><span class="o">.</span><span class="n">Report</span><span class="p">())</span>
        <span class="c1">#5th filter: Track</span>
        <span class="n">h_unfil_sip3d</span> <span class="o">=</span> <span class="n">df_2e2m</span><span class="o">.</span><span class="n">Histo1D</span><span class="p">((</span><span class="sa">f</span><span class="s2">&quot;h_</span><span class="si">{</span><span class="n">part</span><span class="si">}</span><span class="s2">sip3d&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">part</span><span class="si">}</span><span class="s2">_sip3d&quot;</span><span class="p">)</span>
        <span class="n">h_unfil_dxy</span> <span class="o">=</span> <span class="n">df_2e2m</span><span class="o">.</span><span class="n">Histo1D</span><span class="p">((</span><span class="sa">f</span><span class="s2">&quot;h_</span><span class="si">{</span><span class="n">part</span><span class="si">}</span><span class="s2">_dxy&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.02</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">part</span><span class="si">}</span><span class="s2">_dxy&quot;</span><span class="p">)</span>
        <span class="n">h_unfil_dz</span> <span class="o">=</span> <span class="n">df_2e2m</span><span class="o">.</span><span class="n">Histo1D</span><span class="p">((</span><span class="sa">f</span><span class="s2">&quot;h_</span><span class="si">{</span><span class="n">part</span><span class="si">}</span><span class="s2">_dz&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.02</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">part</span><span class="si">}</span><span class="s2">_dz&quot;</span><span class="p">)</span>

        <span class="n">df_sip3d</span> <span class="o">=</span> <span class="n">df_2e2m</span><span class="o">.</span><span class="n">Filter</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;All(</span><span class="si">{</span><span class="n">part</span><span class="si">}</span><span class="s2">_sip3d&lt;4)&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">part</span><span class="si">}</span><span class="s2">_Sip3d cut&quot;</span><span class="p">)</span>
        <span class="n">h_fil_sip3d</span> <span class="o">=</span> <span class="n">df_sip3d</span><span class="o">.</span><span class="n">Histo1D</span><span class="p">((</span><span class="sa">f</span><span class="s2">&quot;h_</span><span class="si">{</span><span class="n">part</span><span class="si">}</span><span class="s2">_sip3d&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">part</span><span class="si">}</span><span class="s2">_sip3d&quot;</span><span class="p">)</span>
        <span class="n">df_dxy</span> <span class="o">=</span> <span class="n">df_2e2m</span><span class="o">.</span><span class="n">Filter</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;All(abs(</span><span class="si">{</span><span class="n">part</span><span class="si">}</span><span class="s2">_dxy)&lt;0.5)&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">part</span><span class="si">}</span><span class="s2">_Dxy cut&quot;</span><span class="p">)</span>
        <span class="n">h_fil_dxy</span> <span class="o">=</span> <span class="n">df_dxy</span><span class="o">.</span><span class="n">Histo1D</span><span class="p">((</span><span class="sa">f</span><span class="s2">&quot;h_</span><span class="si">{</span><span class="n">part</span><span class="si">}</span><span class="s2">_dxy&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.02</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">part</span><span class="si">}</span><span class="s2">_dxy&quot;</span><span class="p">)</span>
        <span class="n">df_dz</span> <span class="o">=</span> <span class="n">df_2e2m</span><span class="o">.</span><span class="n">Filter</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;All(abs(</span><span class="si">{</span><span class="n">part</span><span class="si">}</span><span class="s2">_dz)&lt;1.0)&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">part</span><span class="si">}</span><span class="s2">_Dz cut&quot;</span><span class="p">)</span>
        <span class="n">h_fil_dz</span> <span class="o">=</span> <span class="n">df_dz</span><span class="o">.</span><span class="n">Histo1D</span><span class="p">((</span><span class="sa">f</span><span class="s2">&quot;h_</span><span class="si">{</span><span class="n">part</span><span class="si">}</span><span class="s2">_dz&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.02</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">part</span><span class="si">}</span><span class="s2">_dz&quot;</span><span class="p">)</span>
        <span class="n">filter_dict</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">part</span><span class="si">}</span><span class="s2">_track&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">h_unfil_sip3d</span><span class="p">,</span> <span class="n">h_unfil_dxy</span><span class="p">,</span> <span class="n">h_unfil_dz</span><span class="p">])</span>
        <span class="n">filter_dict</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">part</span><span class="si">}</span><span class="s2">_track&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">h_fil_sip3d</span><span class="p">,</span> <span class="n">h_fil_dxy</span><span class="p">,</span> <span class="n">h_fil_dz</span><span class="p">])</span>
        <span class="n">filter_dict</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">part</span><span class="si">}</span><span class="s2">_track&quot;</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">df_sip3d</span><span class="o">.</span><span class="n">Report</span><span class="p">(),</span> <span class="n">df_dxy</span><span class="o">.</span><span class="n">Report</span><span class="p">(),</span> <span class="n">df_dz</span><span class="o">.</span><span class="n">Report</span><span class="p">()])</span>

    <span class="c1"># Compute z masses and filter</span>
    <span class="n">df_z_mass</span> <span class="o">=</span> <span class="n">df_2e2m</span><span class="o">.</span><span class="n">Define</span><span class="p">(</span><span class="s2">&quot;Z_mass&quot;</span><span class="p">,</span> <span class="s2">&quot;z_mass(Electron_pt, Electron_eta,&quot;</span>\
                               <span class="s2">&quot; Electron_phi, Electron_mass,&quot;</span>\
                               <span class="s2">&quot;Muon_pt, Muon_eta, Muon_phi, Muon_mass)&quot;</span><span class="p">)</span>
    <span class="n">h_unfil_z</span> <span class="o">=</span> <span class="n">df_z_mass</span><span class="o">.</span><span class="n">Histo1D</span><span class="p">((</span><span class="s2">&quot;h_Z_mass&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">140</span><span class="p">),</span> <span class="s2">&quot;Z_mass&quot;</span><span class="p">)</span>
    <span class="c1"># 6th filter: z masses</span>
    <span class="n">df_z</span> <span class="o">=</span> <span class="n">df_z_mass</span><span class="o">.</span><span class="n">Filter</span><span class="p">(</span><span class="s2">&quot;Z_mass[0] &gt; 40 &amp;&amp; Z_mass[0] &lt; 120&quot;</span>\
                            <span class="s2">&quot; &amp;&amp; Z_mass[1] &gt; 12 &amp;&amp; Z_mass[1] &lt; 120&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;First candidate in [40, 120]&quot;</span>\
                            <span class="s2">&quot; and Second candidate in [12, 120]&quot;</span><span class="p">)</span>
    <span class="n">h_fil_z</span> <span class="o">=</span> <span class="n">df_z</span><span class="o">.</span><span class="n">Histo1D</span><span class="p">((</span><span class="s2">&quot;h_Z_mass&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">140</span><span class="p">),</span> <span class="s2">&quot;Z_mass&quot;</span><span class="p">)</span>
    <span class="n">filter_dict</span><span class="p">[</span><span class="s2">&quot;Z_mass&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">h_unfil_z</span><span class="p">)</span>
    <span class="n">filter_dict</span><span class="p">[</span><span class="s2">&quot;Z_mass&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">h_fil_z</span><span class="p">)</span>
    <span class="n">filter_dict</span><span class="p">[</span><span class="s2">&quot;Z_mass&quot;</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_z</span><span class="o">.</span><span class="n">Report</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">filter_dict</span></div>

<div class="viewcode-block" id="good_events"><a class="viewcode-back" href="../../progetto.html#progetto.higgs_2e2mu.good_events">[docs]</a><span class="k">def</span> <span class="nf">good_events</span><span class="p">(</span><span class="n">df_2e2m</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Select the events that pass the cuts used in the 2012 CERN article.</span>
<span class="sd">    (Lazy)</span>

<span class="sd">    Args:</span>
<span class="sd">        df_2e2m (RDataFrame): Prefiltered (2 e and 2 mu) RDF.</span>

<span class="sd">    Returns:</span>
<span class="sd">        RdataFrame: Filtered RDF</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">#angular cuts</span>
    <span class="n">df_eta</span> <span class="o">=</span> <span class="n">df_2e2m</span><span class="o">.</span><span class="n">Filter</span><span class="p">(</span><span class="s2">&quot;All(abs(Electron_eta)&lt;2.5) &amp;&amp; All(abs(Muon_eta)&lt;2.4)&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;Eta_cuts&quot;</span><span class="p">)</span>
    <span class="c1">#transvers momenta cuts</span>
    <span class="n">df_pt</span> <span class="o">=</span> <span class="n">df_eta</span><span class="o">.</span><span class="n">Filter</span><span class="p">(</span><span class="s2">&quot;pt_cut(Muon_pt, Electron_pt)&quot;</span><span class="p">,</span>
                          <span class="s2">&quot;Pt cuts&quot;</span><span class="p">)</span>
    <span class="n">df_dr</span> <span class="o">=</span> <span class="n">df_pt</span><span class="o">.</span><span class="n">Filter</span><span class="p">(</span><span class="s2">&quot;dr_cut(Muon_eta, Muon_phi, Electron_eta, Electron_phi)&quot;</span><span class="p">,</span>
                         <span class="s2">&quot;Dr_cuts&quot;</span><span class="p">)</span>
    <span class="c1">#Request good isolation</span>
    <span class="n">df_iso</span> <span class="o">=</span> <span class="n">df_dr</span><span class="o">.</span><span class="n">Filter</span><span class="p">(</span><span class="s2">&quot;All(abs(Electron_pfRelIso03_all)&lt;0.40) &amp;&amp;&quot;</span>
                          <span class="s2">&quot;All(abs(Muon_pfRelIso04_all)&lt;0.40)&quot;</span><span class="p">,</span>
                          <span class="s2">&quot;Require good isolation&quot;</span><span class="p">)</span>
    <span class="c1">#Filter of Muon and Electron tracks</span>
    <span class="n">df_el_track</span> <span class="o">=</span> <span class="n">df_iso</span><span class="o">.</span><span class="n">Filter</span><span class="p">(</span><span class="s2">&quot;All(Electron_sip3d&lt;4) &amp;&amp;&quot;</span>
                                <span class="s2">&quot; All(abs(Electron_dxy)&lt;0.5) &amp;&amp; &quot;</span>
                                <span class="s2">&quot; All(abs(Electron_dz)&lt;1.0)&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;Electron track close to primary vertex&quot;</span><span class="p">)</span>
    <span class="n">df_mu_track</span> <span class="o">=</span> <span class="n">df_el_track</span><span class="o">.</span><span class="n">Filter</span><span class="p">(</span><span class="s2">&quot;All(Muon_sip3d&lt;4) &amp;&amp; All(abs(Muon_dxy)&lt;0.5) &amp;&amp;&quot;</span>
                                     <span class="s2">&quot;All(abs(Muon_dz)&lt;1.0)&quot;</span><span class="p">,</span>
                                     <span class="s2">&quot;Muon track close to primary vertex&quot;</span><span class="p">)</span>
    <span class="n">df_2p2n</span> <span class="o">=</span> <span class="n">df_mu_track</span><span class="o">.</span><span class="n">Filter</span><span class="p">(</span><span class="s2">&quot;Sum(Electron_charge) == 0 &amp;&amp; Sum(Muon_charge) == 0&quot;</span><span class="p">,</span>
                                 <span class="s2">&quot;Two opposite charged electron and muon pairs&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">df_2p2n</span></div>

<div class="viewcode-block" id="reco_define"><a class="viewcode-back" href="../../progetto.html#progetto.higgs_2e2mu.reco_define">[docs]</a><span class="k">def</span> <span class="nf">reco_define</span><span class="p">(</span><span class="n">df_2e2mu</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Defines all the main variables, such as Z, H and its angular</span>
<span class="sd">    variables. (Lazy)</span>

<span class="sd">    Args:</span>
<span class="sd">        df (RDataFrame): RDF to add new variables to.</span>

<span class="sd">    Returns:</span>
<span class="sd">        RDataFrame: RDF with added variables.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">z_mass_reco</span> <span class="o">=</span> <span class="s2">&quot;z_mass(Electron_pt, Electron_eta, Electron_phi, Electron_mass,&quot;</span>\
                         <span class="s2">&quot;Muon_pt, Muon_eta, Muon_phi, Muon_mass)&quot;</span>
    <span class="n">h_mass_reco</span> <span class="o">=</span> <span class="s2">&quot;h_mass(Electron_pt, Electron_eta, Electron_phi, Electron_mass,&quot;</span>\
                         <span class="s2">&quot;Muon_pt, Muon_eta, Muon_phi, Muon_mass)&quot;</span>
    <span class="n">costheta_star_reco</span> <span class="o">=</span> <span class="s2">&quot;costheta_star(Electron_pt, Electron_eta, Electron_phi, Electron_mass,&quot;</span>\
                         <span class="s2">&quot;Muon_pt, Muon_eta, Muon_phi, Muon_mass)&quot;</span>
    <span class="n">phi_reco</span> <span class="o">=</span> <span class="s2">&quot;measure_phi(Electron_pt, Electron_eta, Electron_phi, Electron_mass, Electron_charge,&quot;</span>\
                            <span class="s2">&quot;Muon_pt, Muon_eta, Muon_phi, Muon_mass, Muon_charge)[0]&quot;</span>
    <span class="n">phi1_reco</span> <span class="o">=</span> <span class="s2">&quot;measure_phi(Electron_pt, Electron_eta, Electron_phi, Electron_mass, Electron_charge,&quot;</span>\
                            <span class="s2">&quot;Muon_pt, Muon_eta, Muon_phi, Muon_mass, Muon_charge)[1]&quot;</span>
    <span class="n">costheta1_reco</span> <span class="o">=</span> <span class="s2">&quot;costheta(Electron_pt, Electron_eta, Electron_phi, Electron_mass, Electron_charge,&quot;</span>\
                              <span class="s2">&quot;Muon_pt, Muon_eta, Muon_phi, Muon_mass, Muon_charge)[0]&quot;</span>
    <span class="n">costheta2_reco</span> <span class="o">=</span> <span class="s2">&quot;costheta(Electron_pt, Electron_eta, Electron_phi, Electron_mass, Electron_charge,&quot;</span>\
                              <span class="s2">&quot;Muon_pt, Muon_eta, Muon_phi, Muon_mass, Muon_charge)[1]&quot;</span>

    <span class="n">df_z_mass</span> <span class="o">=</span> <span class="n">df_2e2mu</span><span class="o">.</span><span class="n">Define</span><span class="p">(</span><span class="s2">&quot;Z_mass&quot;</span><span class="p">,</span> <span class="n">z_mass_reco</span><span class="p">)</span>\
                        <span class="o">.</span><span class="n">Define</span><span class="p">(</span><span class="s2">&quot;H_mass&quot;</span><span class="p">,</span> <span class="n">h_mass_reco</span><span class="p">)</span>\
                        <span class="o">.</span><span class="n">Define</span><span class="p">(</span><span class="s2">&quot;CosTheta_star&quot;</span><span class="p">,</span> <span class="n">costheta_star_reco</span><span class="p">)</span>\
                        <span class="o">.</span><span class="n">Define</span><span class="p">(</span><span class="s2">&quot;Phi&quot;</span><span class="p">,</span> <span class="n">phi_reco</span><span class="p">)</span>\
                        <span class="o">.</span><span class="n">Define</span><span class="p">(</span><span class="s2">&quot;Phi1&quot;</span><span class="p">,</span> <span class="n">phi1_reco</span><span class="p">)</span>\
                        <span class="o">.</span><span class="n">Define</span><span class="p">(</span><span class="s2">&quot;CosTheta1&quot;</span><span class="p">,</span> <span class="n">costheta1_reco</span><span class="p">)</span>\
                        <span class="o">.</span><span class="n">Define</span><span class="p">(</span><span class="s2">&quot;CosTheta2&quot;</span><span class="p">,</span> <span class="n">costheta2_reco</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df_z_mass</span></div>

<div class="viewcode-block" id="reco_higgs"><a class="viewcode-back" href="../../progetto.html#progetto.higgs_2e2mu.reco_higgs">[docs]</a><span class="k">def</span> <span class="nf">reco_higgs</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">weight</span><span class="p">,</span> <span class="n">weight_ang</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Recontruct the Higgs mass and the angular variables. (Lazy)</span>

<span class="sd">    Args:</span>
<span class="sd">        df (RDataFrame): RDF to process.</span>
<span class="sd">        weight (float): Weight values to rescale &quot;sig&quot; and &quot;bkg&quot;</span>
<span class="sd">                        for Higgs mass histogram.</span>
<span class="sd">        weight_ang (float): Weight values to rescale &quot;sig&quot; and &quot;bkg&quot;</span>
<span class="sd">                            for angular variables histograms.</span>

<span class="sd">    Returns:</span>
<span class="sd">        THist1D: Histogram of the reconstructed Higgs mass.</span>
<span class="sd">        RResultPtr&lt; RCutFlowReport &gt;: Report of filters applied.</span>
<span class="sd">        list: list of 5 angular variables histograms.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Selection of only the potential good events</span>
    <span class="n">df_base</span> <span class="o">=</span> <span class="n">good_events</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

    <span class="c1"># Compute z and H masses from it</span>
    <span class="n">df_z_mass</span> <span class="o">=</span> <span class="n">reco_define</span><span class="p">(</span><span class="n">df_base</span><span class="p">)</span>
    <span class="c1">#Filter on z masses</span>
    <span class="n">df_z1</span> <span class="o">=</span> <span class="n">df_z_mass</span><span class="o">.</span><span class="n">Filter</span><span class="p">(</span><span class="s2">&quot;Z_mass[0] &gt; 40 &amp;&amp; Z_mass[0] &lt; 120&quot;</span><span class="p">,</span> <span class="s2">&quot;First candidate in [40, 120]&quot;</span><span class="p">)</span>
    <span class="n">df_z2</span> <span class="o">=</span> <span class="n">df_z1</span><span class="o">.</span><span class="n">Filter</span><span class="p">(</span><span class="s2">&quot;Z_mass[1] &gt; 12 &amp;&amp; Z_mass[1] &lt; 120&quot;</span><span class="p">,</span> <span class="s2">&quot;Second candidate in [12, 120]&quot;</span><span class="p">)</span>

    <span class="c1"># Define weights</span>
    <span class="n">df_reco</span> <span class="o">=</span> <span class="n">df_z2</span><span class="o">.</span><span class="n">Define</span><span class="p">(</span><span class="s2">&quot;weight&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">weight</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">Define</span><span class="p">(</span><span class="s2">&quot;weight_ang&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">weight_ang</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">h_reco_higgs</span> <span class="o">=</span> <span class="n">df_reco</span><span class="o">.</span><span class="n">Histo1D</span><span class="p">((</span><span class="s2">&quot;h_sig_2el2mu&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="mi">70</span><span class="p">,</span> <span class="mi">180</span><span class="p">),</span> <span class="s2">&quot;H_mass&quot;</span><span class="p">,</span> <span class="s2">&quot;weight&quot;</span><span class="p">)</span>

    <span class="c1"># Reconstruction of angular variables</span>
    <span class="n">h_costheta_star</span> <span class="o">=</span> <span class="n">df_reco</span><span class="o">.</span><span class="n">Histo1D</span><span class="p">((</span><span class="s2">&quot;h_costheta_star&quot;</span><span class="p">,</span> <span class="s2">&quot;CosTheta_star&quot;</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="s2">&quot;CosTheta_star&quot;</span><span class="p">,</span> <span class="s2">&quot;weight_ang&quot;</span><span class="p">)</span>
    <span class="n">h_costheta1</span> <span class="o">=</span> <span class="n">df_reco</span><span class="o">.</span><span class="n">Histo1D</span><span class="p">((</span><span class="s2">&quot;h_costheta1&quot;</span><span class="p">,</span> <span class="s2">&quot;CosTheta1&quot;</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="s2">&quot;CosTheta1&quot;</span><span class="p">,</span> <span class="s2">&quot;weight_ang&quot;</span><span class="p">)</span>
    <span class="n">h_costheta2</span> <span class="o">=</span> <span class="n">df_reco</span><span class="o">.</span><span class="n">Histo1D</span><span class="p">((</span><span class="s2">&quot;h_costheta2&quot;</span><span class="p">,</span> <span class="s2">&quot;CosTheta2&quot;</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="s2">&quot;CosTheta2&quot;</span><span class="p">,</span> <span class="s2">&quot;weight_ang&quot;</span><span class="p">)</span>
    <span class="n">h_phi</span> <span class="o">=</span> <span class="n">df_reco</span><span class="o">.</span><span class="n">Histo1D</span><span class="p">((</span><span class="s2">&quot;h_phi&quot;</span><span class="p">,</span> <span class="s2">&quot;Phi&quot;</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.14</span><span class="p">,</span> <span class="mf">3.14</span><span class="p">),</span> <span class="s2">&quot;Phi&quot;</span><span class="p">,</span> <span class="s2">&quot;weight_ang&quot;</span><span class="p">)</span>
    <span class="n">h_phi1</span> <span class="o">=</span> <span class="n">df_reco</span><span class="o">.</span><span class="n">Histo1D</span><span class="p">((</span><span class="s2">&quot;h_phi1&quot;</span><span class="p">,</span> <span class="s2">&quot;Phi1&quot;</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.14</span><span class="p">,</span> <span class="mf">3.14</span><span class="p">),</span> <span class="s2">&quot;Phi1&quot;</span><span class="p">,</span> <span class="s2">&quot;weight_ang&quot;</span><span class="p">)</span>
    <span class="n">list_h_ang</span> <span class="o">=</span> <span class="p">[</span><span class="n">h_costheta_star</span><span class="p">,</span> <span class="n">h_costheta1</span><span class="p">,</span> <span class="n">h_costheta2</span><span class="p">,</span> <span class="n">h_phi</span><span class="p">,</span> <span class="n">h_phi1</span><span class="p">]</span>

    <span class="c1"># Filter on a narrow window of the Higgs mass if applied before lowers</span>
    <span class="c1"># too much the events available to make decent plots.</span>
    <span class="c1"># The report will be useful in the ml analysis.</span>
    <span class="n">df_reco_h</span> <span class="o">=</span> <span class="n">df_reco</span><span class="o">.</span><span class="n">Filter</span><span class="p">(</span><span class="s2">&quot;H_mass &gt; 110 &amp;&amp; H_mass &lt;140&quot;</span><span class="p">,</span>
                               <span class="s2">&quot;Cut on a narrow window: H_mass in [110, 140]&quot;</span><span class="p">)</span>
    <span class="n">report_higgs</span> <span class="o">=</span> <span class="n">df_reco_h</span><span class="o">.</span><span class="n">Report</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">h_reco_higgs</span><span class="p">,</span> <span class="n">report_higgs</span><span class="p">,</span> <span class="n">list_h_ang</span></div>

<div class="viewcode-block" id="standard_request"><a class="viewcode-back" href="../../progetto.html#progetto.higgs_2e2mu.standard_request">[docs]</a><span class="k">def</span> <span class="nf">standard_request</span><span class="p">(</span><span class="n">flag</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Prepares all the necessary requests for the standard analysis.</span>
<span class="sd">    (Lazy)</span>

<span class="sd">    Args:</span>
<span class="sd">        flag (bool): boolean flag to save local file or not.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: dictionary of &quot;sig&quot; and &quot;bkg&quot; filters.</span>
<span class="sd">        list: list of 3 THisto1D of Higgs mass (&quot;sig&quot;, &quot;bkg&quot;, &quot;data&quot;).</span>
<span class="sd">        list: list of 3 RDF Report of Higgs mass (&quot;sig&quot;, &quot;bkg&quot;, &quot;data&quot;).</span>
<span class="sd">        RDataFrame: RDF for ML analysis.</span>
<span class="sd">        OrderedDict: angular variables ordered dictionary.</span>
<span class="sd">                     The keys are the angular variables, the values are</span>
<span class="sd">                     lists of 3 THisto1D of the given variable</span>
<span class="sd">                     (&quot;sig&quot;, &quot;bkg&quot;, &quot;data&quot;).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">df_s</span> <span class="o">=</span> <span class="n">access_df</span><span class="p">(</span><span class="s2">&quot;signal&quot;</span><span class="p">,</span> <span class="n">flag</span><span class="p">,</span> <span class="s2">&quot;std&quot;</span><span class="p">)</span>
    <span class="n">df_b</span> <span class="o">=</span> <span class="n">access_df</span><span class="p">(</span><span class="s2">&quot;background&quot;</span><span class="p">,</span> <span class="n">flag</span><span class="p">,</span> <span class="s2">&quot;std&quot;</span><span class="p">)</span>
    <span class="n">df_d</span> <span class="o">=</span> <span class="n">access_df</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="n">flag</span><span class="p">,</span> <span class="s2">&quot;std&quot;</span><span class="p">)</span>

    <span class="n">df_s1</span> <span class="o">=</span> <span class="n">standard_define</span><span class="p">(</span><span class="n">df_s</span><span class="p">)</span>
    <span class="n">df_b1</span> <span class="o">=</span> <span class="n">standard_define</span><span class="p">(</span><span class="n">df_b</span><span class="p">)</span>
    <span class="n">df_d1</span> <span class="o">=</span> <span class="n">standard_define</span><span class="p">(</span><span class="n">df_d</span><span class="p">)</span>

    <span class="n">start1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="c1">#Request filtered and unfiltered data</span>
    <span class="n">dict_filter</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">dict_filter</span><span class="p">[</span><span class="s2">&quot;sig&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">show_cut</span><span class="p">(</span><span class="n">df_s1</span><span class="p">)</span>
    <span class="n">dict_filter</span><span class="p">[</span><span class="s2">&quot;bkg&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">show_cut</span><span class="p">(</span><span class="n">df_b1</span><span class="p">)</span>

    <span class="c1"># Request ml dataframe</span>
    <span class="n">df_ml</span> <span class="o">=</span> <span class="p">[</span><span class="n">df_s</span><span class="p">,</span> <span class="n">df_b</span><span class="p">]</span>

    <span class="c1"># Weights</span>
    <span class="n">luminosity</span> <span class="o">=</span> <span class="mf">11580.0</span>  <span class="c1"># Integrated luminosity of the data samples</span>
    <span class="n">xsec_sig</span> <span class="o">=</span> <span class="mf">0.0065</span>  <span class="c1"># ZZ-&gt;2el2mu: Standard Model cross-section</span>
    <span class="n">nevt_sig</span> <span class="o">=</span> <span class="mf">299973.0</span>  <span class="c1"># ZZ-&gt;2el2mu: Number of simulated events</span>
    <span class="n">scale_ZZTo4l</span> <span class="o">=</span> <span class="mf">1.386</span>  <span class="c1"># ZZ-&gt;4l: Scale factor for ZZ to four leptons</span>
    <span class="n">xsec_bkg</span> <span class="o">=</span> <span class="mf">0.18</span>  <span class="c1"># ZZ-&gt;2el2mu: Standard Model cross-section</span>
    <span class="n">nevt_bkg</span> <span class="o">=</span> <span class="mf">1497445.0</span>  <span class="c1"># ZZ-&gt;2el2mu: Number of simulated events</span>
    <span class="n">weight_sig</span> <span class="o">=</span> <span class="n">luminosity</span> <span class="o">*</span> <span class="n">xsec_sig</span> <span class="o">/</span> <span class="n">nevt_sig</span>
    <span class="n">weight_bkg</span> <span class="o">=</span> <span class="n">luminosity</span> <span class="o">*</span> <span class="n">xsec_bkg</span> <span class="o">*</span> <span class="n">scale_ZZTo4l</span> <span class="o">/</span> <span class="n">nevt_bkg</span>
    <span class="n">weight_data</span> <span class="o">=</span> <span class="n">weight_ang_data</span> <span class="o">=</span> <span class="mf">1.0</span>

    <span class="n">weight_ang_sig</span> <span class="o">=</span> <span class="mi">91</span><span class="o">/</span><span class="mi">12065</span>
    <span class="n">weight_ang_bkg</span> <span class="o">=</span> <span class="mi">91</span><span class="o">/</span><span class="mi">51237</span>

    <span class="c1"># Request all the necessary to reconstruct the Higgs mass</span>
    <span class="n">h_sig_higgs</span><span class="p">,</span> <span class="n">report_sig</span><span class="p">,</span> <span class="n">h_sig_ang</span> <span class="o">=</span> <span class="n">reco_higgs</span><span class="p">(</span><span class="n">df_s1</span><span class="p">,</span> <span class="n">weight_sig</span><span class="p">,</span> <span class="n">weight_ang_sig</span><span class="p">)</span>
    <span class="n">h_bkg_higgs</span><span class="p">,</span> <span class="n">report_bkg</span><span class="p">,</span> <span class="n">h_bkg_ang</span> <span class="o">=</span> <span class="n">reco_higgs</span><span class="p">(</span><span class="n">df_b1</span><span class="p">,</span> <span class="n">weight_bkg</span><span class="p">,</span> <span class="n">weight_ang_bkg</span><span class="p">)</span>
    <span class="n">h_data_higgs</span><span class="p">,</span> <span class="n">report_data</span><span class="p">,</span> <span class="n">h_data_ang</span> <span class="o">=</span> <span class="n">reco_higgs</span><span class="p">(</span><span class="n">df_d1</span><span class="p">,</span> <span class="n">weight_data</span><span class="p">,</span> <span class="n">weight_ang_data</span><span class="p">)</span>
    <span class="n">stop1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">dict_angular</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">({</span><span class="s2">&quot;costheta_star&quot;</span><span class="p">:[],</span> <span class="s2">&quot;costheta1&quot;</span><span class="p">:[],</span> <span class="s2">&quot;costheta2&quot;</span><span class="p">:[],</span>
                                <span class="s2">&quot;phi&quot;</span><span class="p">:[],</span> <span class="s2">&quot;phi1&quot;</span><span class="p">:[]})</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">h_list</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dict_angular</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
        <span class="n">h_list</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">h_sig_ang</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">h_bkg_ang</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">h_data_ang</span><span class="p">[</span><span class="n">idx</span><span class="p">]])</span>

    <span class="n">list_higgs</span> <span class="o">=</span> <span class="p">[</span><span class="n">h_sig_higgs</span><span class="p">,</span> <span class="n">h_bkg_higgs</span><span class="p">,</span> <span class="n">h_data_higgs</span><span class="p">]</span>
    <span class="n">list_rep_higgs</span> <span class="o">=</span> <span class="p">[</span><span class="n">report_sig</span><span class="p">,</span> <span class="n">report_bkg</span><span class="p">,</span> <span class="n">report_data</span><span class="p">]</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;standard request time: </span><span class="si">{</span><span class="n">stop1</span><span class="o">-</span><span class="n">start1</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dict_filter</span><span class="p">,</span> <span class="n">list_higgs</span><span class="p">,</span> <span class="n">list_rep_higgs</span><span class="p">,</span> <span class="n">df_ml</span><span class="p">,</span> <span class="n">dict_angular</span></div>

<div class="viewcode-block" id="filtered_plot"><a class="viewcode-back" href="../../progetto.html#progetto.higgs_2e2mu.filtered_plot">[docs]</a><span class="k">def</span> <span class="nf">filtered_plot</span><span class="p">(</span><span class="n">histo_sig</span><span class="p">,</span> <span class="n">histo_bkg</span><span class="p">,</span> <span class="n">reps_sig</span><span class="p">,</span> <span class="n">reps_bkg</span><span class="p">,</span> <span class="n">fil</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Generate histogram(s) figure for given filter. Save to file.</span>

<span class="sd">    Multiple histograms (filter with more than one variable) are generated</span>
<span class="sd">    on separated plots and put in the same figure.</span>

<span class="sd">    Args:</span>
<span class="sd">        histo_sig (list): list of unfiltered and filtered histogram(s) of &quot;sig&quot;.</span>
<span class="sd">        histo_bkg (list): list of unfiltered and filtered histogram(s) of &quot;bkg&quot;.</span>
<span class="sd">        reps_sig (list): list of filter report(s) of &quot;sig&quot;.</span>
<span class="sd">        reps_bkg (list): list of filter report(s) of &quot;bkg&quot;.</span>
<span class="sd">        fil (str): filter name, used to set title of plot and save file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">h_uf_s</span><span class="p">,</span> <span class="n">h_f_s</span> <span class="o">=</span> <span class="n">histo_sig</span>
    <span class="n">h_uf_b</span><span class="p">,</span> <span class="n">h_f_b</span> <span class="o">=</span> <span class="n">histo_bkg</span>

    <span class="c1"># Add canvas</span>
    <span class="n">canvas</span> <span class="o">=</span> <span class="n">ROOT</span><span class="o">.</span><span class="n">TCanvas</span><span class="p">(</span><span class="s2">&quot;canvas&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="mi">800</span><span class="p">,</span> <span class="mi">500</span><span class="p">)</span>
    <span class="n">canvas</span><span class="o">.</span><span class="n">cd</span><span class="p">()</span>

    <span class="c1"># Add Legend</span>
    <span class="n">legend</span> <span class="o">=</span> <span class="n">ROOT</span><span class="o">.</span><span class="n">TLegend</span><span class="p">(</span><span class="mf">0.18</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">,</span> <span class="mf">0.33</span><span class="p">,</span> <span class="mf">0.85</span><span class="p">)</span>
    <span class="n">legend</span><span class="o">.</span><span class="n">SetFillColor</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">legend</span><span class="o">.</span><span class="n">SetBorderSize</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">legend</span><span class="o">.</span><span class="n">SetLineWidth</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">legend</span><span class="o">.</span><span class="n">SetTextSize</span><span class="p">(</span><span class="mf">0.025</span><span class="p">)</span>

    <span class="n">delta_y</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">h_f_s</span><span class="p">)</span>
    <span class="c1"># Add latek note</span>
    <span class="n">latex</span> <span class="o">=</span> <span class="n">ROOT</span><span class="o">.</span><span class="n">TLatex</span><span class="p">()</span>
    <span class="n">latex</span><span class="o">.</span><span class="n">SetNDC</span><span class="p">()</span>
    <span class="n">latex</span><span class="o">.</span><span class="n">SetTextSize</span><span class="p">(</span><span class="mf">0.04</span><span class="p">)</span>

    <span class="n">units_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Isolation&quot;</span><span class="p">:[</span><span class="s2">&quot;Electron PfRellIso3&quot;</span><span class="p">,</span> <span class="s2">&quot;Muon PfRellIso4&quot;</span><span class="p">],</span>
                  <span class="s2">&quot;Eta&quot;</span><span class="p">:[</span><span class="s2">&quot;Electron Eta [rad]&quot;</span><span class="p">,</span> <span class="s2">&quot;Muon Eta [rad]&quot;</span><span class="p">],</span>
                  <span class="s2">&quot;Dr&quot;</span><span class="p">:[</span><span class="s2">&quot;Electron #DeltaR [rad]&quot;</span><span class="p">,</span> <span class="s2">&quot;Muon #DeltaR [rad]&quot;</span><span class="p">],</span>
                  <span class="s2">&quot;Pt&quot;</span><span class="p">:[</span><span class="s2">&quot;Electron Pt [GeV]&quot;</span><span class="p">,</span> <span class="s2">&quot;Muon Pt [GeV]&quot;</span><span class="p">],</span>
                  <span class="s2">&quot;Muon_track&quot;</span><span class="p">:[</span><span class="s2">&quot;Muon_sip3d&quot;</span><span class="p">,</span> <span class="s2">&quot;Muon dxy [cm]&quot;</span><span class="p">,</span> <span class="s2">&quot;Muon dz [cm]&quot;</span><span class="p">],</span>
                  <span class="s2">&quot;Electron_track&quot;</span><span class="p">:[</span><span class="s2">&quot;Electron_sip3d&quot;</span><span class="p">,</span> <span class="s2">&quot;Electron dxy [cm]&quot;</span><span class="p">,</span> <span class="s2">&quot;Electron dz [cm]&quot;</span><span class="p">],</span>
                  <span class="s2">&quot;Z_mass&quot;</span><span class="p">:[</span><span class="s2">&quot;Z mass [GeV]&quot;</span><span class="p">]}</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">h1</span><span class="p">,</span> <span class="n">h2</span><span class="p">,</span> <span class="n">h3</span><span class="p">,</span> <span class="n">h4</span><span class="p">,</span> <span class="n">rep12</span><span class="p">,</span> <span class="n">rep34</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">h_uf_s</span><span class="p">,</span> <span class="n">h_f_s</span><span class="p">,</span>
                                                           <span class="n">h_uf_b</span><span class="p">,</span> <span class="n">h_f_b</span><span class="p">,</span>
                                                           <span class="n">reps_sig</span><span class="p">,</span> <span class="n">reps_bkg</span><span class="p">)):</span>
        <span class="n">canvas</span><span class="o">.</span><span class="n">cd</span><span class="p">()</span>
        <span class="n">h_ustyle_s</span> <span class="o">=</span> <span class="n">style</span><span class="p">(</span><span class="n">h1</span><span class="p">,</span> <span class="s2">&quot;e&quot;</span><span class="p">,</span> <span class="n">ROOT</span><span class="o">.</span><span class="n">kRed</span><span class="p">)</span>
        <span class="n">h_fstyle_s</span> <span class="o">=</span> <span class="n">style</span><span class="p">(</span><span class="n">h2</span><span class="p">,</span> <span class="s2">&quot;f&quot;</span><span class="p">,</span> <span class="n">ROOT</span><span class="o">.</span><span class="n">kRed</span><span class="p">)</span>
        <span class="n">h_ustyle_b</span> <span class="o">=</span> <span class="n">style</span><span class="p">(</span><span class="n">h3</span><span class="p">,</span> <span class="s2">&quot;e&quot;</span><span class="p">,</span> <span class="n">ROOT</span><span class="o">.</span><span class="n">kAzure</span><span class="p">)</span>
        <span class="n">h_fstyle_b</span> <span class="o">=</span> <span class="n">style</span><span class="p">(</span><span class="n">h4</span><span class="p">,</span> <span class="s2">&quot;f&quot;</span><span class="p">,</span> <span class="n">ROOT</span><span class="o">.</span><span class="n">kAzure</span><span class="p">)</span>

        <span class="n">pad</span> <span class="o">=</span> <span class="n">ROOT</span><span class="o">.</span><span class="n">TPad</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;pad_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;pad_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="o">*</span><span class="n">delta_y</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="n">delta_y</span><span class="p">)</span>
        <span class="n">pad</span><span class="o">.</span><span class="n">Draw</span><span class="p">()</span>
        <span class="n">pad</span><span class="o">.</span><span class="n">cd</span><span class="p">()</span>
        <span class="n">h_ustyle_b</span><span class="o">.</span><span class="n">GetXaxis</span><span class="p">()</span><span class="o">.</span><span class="n">SetTitle</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">units_dict</span><span class="p">[</span><span class="n">fil</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">h_ustyle_b</span><span class="o">.</span><span class="n">Draw</span><span class="p">()</span>
        <span class="n">h_fstyle_b</span><span class="o">.</span><span class="n">Draw</span><span class="p">(</span><span class="s2">&quot;SAME&quot;</span><span class="p">)</span>
        <span class="n">h_ustyle_s</span><span class="o">.</span><span class="n">Draw</span><span class="p">(</span><span class="s2">&quot;SAME&quot;</span><span class="p">)</span>
        <span class="n">h_fstyle_s</span><span class="o">.</span><span class="n">Draw</span><span class="p">(</span><span class="s2">&quot;SAME&quot;</span><span class="p">)</span>
        <span class="n">cut_eff_s</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">cut_eff_b</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">cur_rep_s</span><span class="p">,</span> <span class="n">cur_rep_b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">rep12</span><span class="p">,</span> <span class="n">rep34</span><span class="p">):</span>
            <span class="n">cut_eff_s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cur_rep_s</span><span class="o">.</span><span class="n">GetEff</span><span class="p">())</span>
            <span class="n">cut_eff_b</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cur_rep_b</span><span class="o">.</span><span class="n">GetEff</span><span class="p">())</span>

        <span class="n">latex</span><span class="o">.</span><span class="n">DrawText</span><span class="p">(</span><span class="mf">0.68</span><span class="p">,</span> <span class="mf">0.67</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Sig evt pass: </span><span class="si">{</span><span class="n">cut_eff_s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
        <span class="n">latex</span><span class="o">.</span><span class="n">DrawText</span><span class="p">(</span><span class="mf">0.68</span><span class="p">,</span> <span class="mf">0.73</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Bkg evt pass: </span><span class="si">{</span><span class="n">cut_eff_b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>

        <span class="n">sig_pass</span> <span class="o">=</span> <span class="n">h_fstyle_s</span><span class="o">.</span><span class="n">GetEntries</span><span class="p">()</span><span class="o">/</span><span class="n">h_ustyle_s</span><span class="o">.</span><span class="n">GetEntries</span><span class="p">()</span><span class="o">*</span><span class="mi">100</span>
        <span class="n">bkg_pass</span> <span class="o">=</span> <span class="n">h_fstyle_b</span><span class="o">.</span><span class="n">GetEntries</span><span class="p">()</span><span class="o">/</span><span class="n">h_ustyle_b</span><span class="o">.</span><span class="n">GetEntries</span><span class="p">()</span><span class="o">*</span><span class="mi">100</span>
        <span class="n">latex</span><span class="o">.</span><span class="n">DrawText</span><span class="p">(</span><span class="mf">0.68</span><span class="p">,</span> <span class="mf">0.79</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Sig cnt pass: </span><span class="si">{</span><span class="n">sig_pass</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
        <span class="n">latex</span><span class="o">.</span><span class="n">DrawText</span><span class="p">(</span><span class="mf">0.68</span><span class="p">,</span> <span class="mf">0.85</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Bkg cnt pass: </span><span class="si">{</span><span class="n">bkg_pass</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>

    <span class="n">h_ustyle_b</span><span class="o">.</span><span class="n">SetTitle</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fil</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">legend</span><span class="o">.</span><span class="n">AddEntry</span><span class="p">(</span><span class="n">h_uf_s</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;Signal Unfilterd&quot;</span><span class="p">)</span>
    <span class="n">legend</span><span class="o">.</span><span class="n">AddEntry</span><span class="p">(</span><span class="n">h_f_s</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;Signal Filtered&quot;</span><span class="p">)</span>
    <span class="n">legend</span><span class="o">.</span><span class="n">AddEntry</span><span class="p">(</span><span class="n">h_uf_b</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;Bkg Unfilterd&quot;</span><span class="p">)</span>
    <span class="n">legend</span><span class="o">.</span><span class="n">AddEntry</span><span class="p">(</span><span class="n">h_f_b</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;Bkg Filtered&quot;</span><span class="p">)</span>
    <span class="n">legend</span><span class="o">.</span><span class="n">Draw</span><span class="p">()</span>

    <span class="c1">#Save plot</span>
    <span class="n">canvas</span><span class="o">.</span><span class="n">SaveAs</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fil</span><span class="si">}</span><span class="s2">.pdf&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="higgs_plot"><a class="viewcode-back" href="../../progetto.html#progetto.higgs_2e2mu.higgs_plot">[docs]</a><span class="k">def</span> <span class="nf">higgs_plot</span><span class="p">(</span><span class="n">histos_higgs</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Plot reconstructed Higgs mass for signal, background and data.</span>
<span class="sd">    Save figure to file.</span>

<span class="sd">    Args:</span>
<span class="sd">        histos_higgs (list): list of histograms of Higgs mass</span>
<span class="sd">                                 of &quot;sig&quot;, &quot;bkg&quot; and &quot;data&quot;.</span>
<span class="sd">        filename (str): name of file to save.</span>
<span class="sd">    &quot;&quot;&quot;</span>


    <span class="n">titles_units_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;costheta_star&quot;</span><span class="p">:[</span><span class="s2">&quot;cos#Theta*&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">],</span> <span class="s2">&quot;costheta1&quot;</span><span class="p">:[</span><span class="s2">&quot;cos#Theta_</span><span class="si">{1}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">],</span>
                         <span class="s2">&quot;costheta2&quot;</span><span class="p">:[</span><span class="s2">&quot;cos#Theta_</span><span class="si">{2}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">],</span>
                         <span class="s2">&quot;phi&quot;</span><span class="p">:[</span><span class="s2">&quot;#Phi&quot;</span><span class="p">,</span> <span class="s2">&quot;[rad]&quot;</span><span class="p">],</span> <span class="s2">&quot;phi1&quot;</span><span class="p">:[</span><span class="s2">&quot;#Phi_</span><span class="si">{1}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;[rad]&quot;</span><span class="p">],</span>
                         <span class="s2">&quot;h_mass&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;M_{2e2#mu}&quot;</span><span class="p">,</span> <span class="s2">&quot;[GeV]&quot;</span><span class="p">]}</span>

    <span class="c1"># Add canvas</span>
    <span class="n">canvas_s</span> <span class="o">=</span> <span class="n">ROOT</span><span class="o">.</span><span class="n">TCanvas</span><span class="p">(</span><span class="s2">&quot;canvas_s&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="mi">800</span><span class="p">,</span> <span class="mi">700</span><span class="p">)</span>

    <span class="n">h_signal</span> <span class="o">=</span> <span class="n">style</span><span class="p">(</span><span class="n">histos_higgs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;e&quot;</span><span class="p">,</span> <span class="n">ROOT</span><span class="o">.</span><span class="n">kRed</span><span class="p">)</span>
    <span class="n">h_background</span> <span class="o">=</span> <span class="n">style</span><span class="p">(</span><span class="n">histos_higgs</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;f&quot;</span><span class="p">,</span> <span class="n">ROOT</span><span class="o">.</span><span class="n">kAzure</span><span class="p">)</span>
    <span class="n">h_data</span> <span class="o">=</span> <span class="n">style</span><span class="p">(</span><span class="n">histos_higgs</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="s2">&quot;m&quot;</span><span class="p">,</span> <span class="n">ROOT</span><span class="o">.</span><span class="n">kBlack</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">filename</span> <span class="o">==</span> <span class="s2">&quot;h_mass&quot;</span><span class="p">:</span>
        <span class="n">h_background</span><span class="o">.</span><span class="n">GetYaxis</span><span class="p">()</span><span class="o">.</span><span class="n">SetRangeUser</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
        <span class="n">h_background</span><span class="o">.</span><span class="n">SetTitle</span><span class="p">(</span><span class="s2">&quot;H#rightarrowZZ#rightarrow2e2#mu&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">h_background</span><span class="o">.</span><span class="n">GetYaxis</span><span class="p">()</span><span class="o">.</span><span class="n">SetRangeUser</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
        <span class="n">h_background</span><span class="o">.</span><span class="n">SetTitle</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">titles_units_dict</span><span class="p">[</span><span class="n">filename</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">h_background</span><span class="o">.</span><span class="n">GetXaxis</span><span class="p">()</span><span class="o">.</span><span class="n">SetTitle</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">titles_units_dict</span><span class="p">[</span><span class="n">filename</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">h_background</span><span class="o">.</span><span class="n">GetYaxis</span><span class="p">()</span><span class="o">.</span><span class="n">SetTitle</span><span class="p">(</span><span class="s2">&quot;Normalized event counts&quot;</span><span class="p">)</span>

    <span class="n">canvas_s</span><span class="o">.</span><span class="n">cd</span><span class="p">()</span>
    <span class="n">h_background</span><span class="o">.</span><span class="n">Draw</span><span class="p">(</span><span class="s2">&quot;HIST&quot;</span><span class="p">)</span>
    <span class="n">h_signal</span><span class="o">.</span><span class="n">Draw</span><span class="p">(</span><span class="s2">&quot;HIST SAME&quot;</span><span class="p">)</span>
    <span class="n">h_data</span><span class="o">.</span><span class="n">Draw</span><span class="p">(</span><span class="s2">&quot;PE1 SAME&quot;</span><span class="p">)</span>

    <span class="c1"># Add Legend</span>
    <span class="n">legend</span> <span class="o">=</span> <span class="n">ROOT</span><span class="o">.</span><span class="n">TLegend</span><span class="p">(</span><span class="mf">0.7</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">,</span> <span class="mf">0.85</span><span class="p">,</span> <span class="mf">0.85</span><span class="p">)</span>
    <span class="n">legend</span><span class="o">.</span><span class="n">SetFillColor</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">legend</span><span class="o">.</span><span class="n">SetBorderSize</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">legend</span><span class="o">.</span><span class="n">SetLineWidth</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">legend</span><span class="o">.</span><span class="n">SetTextSize</span><span class="p">(</span><span class="mf">0.025</span><span class="p">)</span>

    <span class="n">legend</span><span class="o">.</span><span class="n">AddEntry</span><span class="p">(</span><span class="n">histos_higgs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;Signal&quot;</span><span class="p">)</span>
    <span class="n">legend</span><span class="o">.</span><span class="n">AddEntry</span><span class="p">(</span><span class="n">histos_higgs</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;Background&quot;</span><span class="p">)</span>
    <span class="n">legend</span><span class="o">.</span><span class="n">AddEntry</span><span class="p">(</span><span class="n">histos_higgs</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="s2">&quot;Data&quot;</span><span class="p">)</span>
    <span class="n">legend</span><span class="o">.</span><span class="n">Draw</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">filename</span> <span class="o">==</span> <span class="s2">&quot;h_mass&quot;</span><span class="p">:</span>
        <span class="n">latex</span> <span class="o">=</span> <span class="n">ROOT</span><span class="o">.</span><span class="n">TLatex</span><span class="p">()</span>
        <span class="n">latex</span><span class="o">.</span><span class="n">SetNDC</span><span class="p">()</span>
        <span class="n">latex</span><span class="o">.</span><span class="n">SetTextSize</span><span class="p">(</span><span class="mf">0.02</span><span class="p">)</span>
        <span class="n">latex</span><span class="o">.</span><span class="n">DrawLatexNDC</span><span class="p">(</span><span class="mf">0.7</span><span class="p">,</span> <span class="mf">0.92</span><span class="p">,</span> <span class="s2">&quot;#sqrt</span><span class="si">{s}</span><span class="s2"> = 8 TeV, L_</span><span class="si">{int}</span><span class="s2"> = 11.6 fb^{-1}&quot;</span><span class="p">)</span>

    <span class="c1">#Save plot</span>
    <span class="n">canvas_s</span><span class="o">.</span><span class="n">SaveAs</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">.pdf&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="standard_retrieve"><a class="viewcode-back" href="../../progetto.html#progetto.higgs_2e2mu.standard_retrieve">[docs]</a><span class="k">def</span> <span class="nf">standard_retrieve</span><span class="p">(</span><span class="n">filters</span><span class="p">,</span> <span class="n">histos_higgs</span><span class="p">,</span> <span class="n">reps_higgs</span><span class="p">,</span> <span class="n">angulars</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Retrieve and plot requested histograms of Higgs mass and</span>
<span class="sd">    angular variables. (Instant)</span>

<span class="sd">    Generate 6 histogram plots: one for Higgs mass and one for each</span>
<span class="sd">    of the angular variables. Each histogram contains 3 datasets.</span>

<span class="sd">    If the code is in only standard mode, here the event loop will be triggered</span>

<span class="sd">    Args:</span>
<span class="sd">        filters (dict): dictionary of &quot;sig&quot; and &quot;bkg&quot; filters.</span>
<span class="sd">        histos_higgs (list): list of 3 THisto1D of Higgs mass (&quot;sig&quot;, &quot;bkg&quot;, &quot;data&quot;).</span>
<span class="sd">        reps_higgs (list): list of 3 RDF Report of Higgs mass (&quot;sig&quot;, &quot;bkg&quot;, &quot;data&quot;).</span>
<span class="sd">        angulars (OrderedDict): angular variables ordered dictionary.</span>
<span class="sd">                               The keys are the angular variables, the values are</span>
<span class="sd">                               lists of 3 THisto1D of the given variable</span>
<span class="sd">                               (&quot;sig&quot;, &quot;bkg&quot;, &quot;data&quot;).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">start2</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">filters_data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;sig&quot;</span><span class="p">:{</span><span class="s2">&quot;Isolation&quot;</span><span class="p">:[[],</span> <span class="p">[],</span> <span class="p">[]],</span> <span class="s2">&quot;Eta&quot;</span><span class="p">:[[],</span> <span class="p">[],</span> <span class="p">[]],</span>
                           <span class="s2">&quot;Dr&quot;</span><span class="p">:[[],</span> <span class="p">[],</span> <span class="p">[]],</span> <span class="s2">&quot;Pt&quot;</span><span class="p">:[[],</span> <span class="p">[],</span> <span class="p">[]],</span>
                           <span class="s2">&quot;Electron_track&quot;</span><span class="p">:[[],</span> <span class="p">[],</span> <span class="p">[]],</span> <span class="s2">&quot;Muon_track&quot;</span><span class="p">:[[],</span> <span class="p">[],</span> <span class="p">[]],</span>
                           <span class="s2">&quot;Z_mass&quot;</span><span class="p">:[[],</span> <span class="p">[],</span> <span class="p">[]]},</span>
                    <span class="s2">&quot;bkg&quot;</span><span class="p">:{</span><span class="s2">&quot;Isolation&quot;</span><span class="p">:[[],</span> <span class="p">[],</span> <span class="p">[]],</span> <span class="s2">&quot;Eta&quot;</span><span class="p">:[[],</span> <span class="p">[],</span> <span class="p">[]],</span>
                           <span class="s2">&quot;Dr&quot;</span><span class="p">:[[],</span> <span class="p">[],</span> <span class="p">[]],</span> <span class="s2">&quot;Pt&quot;</span><span class="p">:[[],</span> <span class="p">[],</span> <span class="p">[]],</span>
                           <span class="s2">&quot;Electron_track&quot;</span><span class="p">:[[],</span> <span class="p">[],</span> <span class="p">[]],</span> <span class="s2">&quot;Muon_track&quot;</span><span class="p">:[[],</span> <span class="p">[],</span> <span class="p">[]],</span>
                           <span class="s2">&quot;Z_mass&quot;</span><span class="p">:[[],</span> <span class="p">[],</span> <span class="p">[]]}}</span>
    <span class="k">for</span> <span class="n">cut</span> <span class="ow">in</span> <span class="n">filters</span><span class="p">[</span><span class="s2">&quot;sig&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">filters</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">histo_list</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">filters</span><span class="p">[</span><span class="n">ch</span><span class="p">][</span><span class="n">cut</span><span class="p">][:</span><span class="mi">2</span><span class="p">]):</span>
                <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">histo_list</span><span class="p">:</span>
                    <span class="n">filters_data</span><span class="p">[</span><span class="n">ch</span><span class="p">][</span><span class="n">cut</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">GetValue</span><span class="p">())</span>
            <span class="n">filters_data</span><span class="p">[</span><span class="n">ch</span><span class="p">][</span><span class="n">cut</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">filters</span><span class="p">[</span><span class="n">ch</span><span class="p">][</span><span class="n">cut</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">h_sig</span> <span class="o">=</span> <span class="n">filters_data</span><span class="p">[</span><span class="s2">&quot;sig&quot;</span><span class="p">][</span><span class="n">cut</span><span class="p">][:</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">rep_sig</span> <span class="o">=</span> <span class="n">filters_data</span><span class="p">[</span><span class="s2">&quot;sig&quot;</span><span class="p">][</span><span class="n">cut</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>

        <span class="n">h_bkg</span> <span class="o">=</span> <span class="n">filters_data</span><span class="p">[</span><span class="s2">&quot;bkg&quot;</span><span class="p">][</span><span class="n">cut</span><span class="p">][:</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">rep_bkg</span> <span class="o">=</span> <span class="n">filters_data</span><span class="p">[</span><span class="s2">&quot;bkg&quot;</span><span class="p">][</span><span class="n">cut</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>

        <span class="n">filtered_plot</span><span class="p">(</span><span class="n">h_sig</span><span class="p">,</span> <span class="n">h_bkg</span><span class="p">,</span> <span class="n">rep_sig</span><span class="p">,</span> <span class="n">rep_bkg</span><span class="p">,</span> <span class="n">cut</span><span class="p">)</span>

    <span class="n">list_higgs_data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">histos_higgs</span><span class="p">:</span>
        <span class="n">h_higgs_data</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">GetValue</span><span class="p">()</span>
        <span class="n">list_higgs_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">h_higgs_data</span><span class="p">)</span>
    <span class="n">higgs_plot</span><span class="p">(</span><span class="n">list_higgs_data</span><span class="p">,</span> <span class="s2">&quot;h_mass&quot;</span><span class="p">)</span>

    <span class="n">angular_data</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">({</span><span class="s2">&quot;costheta_star&quot;</span><span class="p">:[],</span> <span class="s2">&quot;costheta1&quot;</span><span class="p">:[],</span> <span class="s2">&quot;costheta2&quot;</span><span class="p">:[],</span>
                                <span class="s2">&quot;phi&quot;</span><span class="p">:[],</span> <span class="s2">&quot;phi1&quot;</span><span class="p">:[]})</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">hist_list</span> <span class="ow">in</span> <span class="n">angulars</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">hist_list</span><span class="p">:</span>
            <span class="n">angular_data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">GetValue</span><span class="p">())</span>
        <span class="n">higgs_plot</span><span class="p">(</span><span class="n">angular_data</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">key</span><span class="p">)</span>

    <span class="c1"># Print on shell the complete report on the standard analysis</span>
    <span class="k">for</span> <span class="n">ch</span><span class="p">,</span> <span class="n">rep</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="s2">&quot;signal&quot;</span><span class="p">,</span> <span class="s2">&quot;bakground&quot;</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">],</span> <span class="n">reps_higgs</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ch</span><span class="si">}</span><span class="s2"> report:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">rep</span><span class="o">.</span><span class="n">Print</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">()</span>
    <span class="n">stop2</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Standard retrieve time: </span><span class="si">{</span><span class="n">stop2</span> <span class="o">-</span> <span class="n">start2</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="ml_request"><a class="viewcode-back" href="../../progetto.html#progetto.higgs_2e2mu.ml_request">[docs]</a><span class="k">def</span> <span class="nf">ml_request</span><span class="p">(</span><span class="n">ml_data</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Prepare dataset to be readable by the machine learning  method.</span>
<span class="sd">    (Lazy)</span>

<span class="sd">    Check if local dataset are already present (from previous execution</span>
<span class="sd">    or manual import) and load the RDF to return.</span>

<span class="sd">    If not then filter data and define variables useful for ML training.</span>
<span class="sd">    Save to local file (through lazy Snapshot) the RDF to return.</span>

<span class="sd">    Perform additional filter on Higgs mass only to produce Reports, the</span>
<span class="sd">    output RDF are not filtered on it.</span>

<span class="sd">    Args:</span>
<span class="sd">        ml_data (list): list of RDF to process.</span>

<span class="sd">    Returns:</span>
<span class="sd">        list: list of prepared RDF</span>
<span class="sd">        list: list of Report H mass filters on the prepared RDF</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">list_df_train</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="s2">&quot;train_signal.root&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="s2">&quot;train_background.root&quot;</span><span class="p">):</span>
        <span class="n">list_df_train</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">ROOT</span><span class="o">.</span><span class="n">RDataFrame</span><span class="p">(</span><span class="s2">&quot;Events&quot;</span><span class="p">,</span> <span class="s2">&quot;train_signal.root&quot;</span><span class="p">),</span>
                              <span class="n">ROOT</span><span class="o">.</span><span class="n">RDataFrame</span><span class="p">(</span><span class="s2">&quot;Events&quot;</span><span class="p">,</span> <span class="s2">&quot;train_background.root&quot;</span><span class="p">)])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># These are all the variables that will be put in the training df</span>
        <span class="n">ml_var</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Muon_pt_1&quot;</span><span class="p">,</span> <span class="s2">&quot;Muon_pt_2&quot;</span><span class="p">,</span> <span class="s2">&quot;Electron_pt_1&quot;</span><span class="p">,</span> <span class="s2">&quot;Electron_pt_2&quot;</span><span class="p">,</span>
                  <span class="s2">&quot;Muon_mass_1&quot;</span><span class="p">,</span> <span class="s2">&quot;Muon_mass_2&quot;</span><span class="p">,</span> <span class="s2">&quot;Electron_mass_1&quot;</span><span class="p">,</span> <span class="s2">&quot;Electron_mass_2&quot;</span><span class="p">,</span>
                  <span class="s2">&quot;Muon_eta_1&quot;</span><span class="p">,</span> <span class="s2">&quot;Muon_eta_2&quot;</span><span class="p">,</span> <span class="s2">&quot;Electron_eta_1&quot;</span><span class="p">,</span> <span class="s2">&quot;Electron_eta_2&quot;</span><span class="p">,</span>
                  <span class="s2">&quot;Muon_phi_1&quot;</span><span class="p">,</span> <span class="s2">&quot;Muon_phi_2&quot;</span><span class="p">,</span> <span class="s2">&quot;Electron_phi_1&quot;</span><span class="p">,</span> <span class="s2">&quot;Electron_phi_2&quot;</span><span class="p">,</span>
                  <span class="s2">&quot;CosTheta_star&quot;</span><span class="p">,</span> <span class="s2">&quot;CosTheta1&quot;</span><span class="p">,</span> <span class="s2">&quot;CosTheta2&quot;</span><span class="p">,</span> <span class="s2">&quot;Phi&quot;</span><span class="p">,</span> <span class="s2">&quot;Phi1&quot;</span><span class="p">,</span> <span class="s2">&quot;H_mass&quot;</span><span class="p">]</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="n">ROOT</span><span class="o">.</span><span class="n">std</span><span class="o">.</span><span class="n">vector</span><span class="p">(</span><span class="s2">&quot;string&quot;</span><span class="p">)()</span>
        <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">ml_var</span><span class="p">:</span>
            <span class="n">columns</span><span class="o">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">column</span><span class="p">)</span>

        <span class="n">snapshotOptions</span> <span class="o">=</span> <span class="n">ROOT</span><span class="o">.</span><span class="n">RDF</span><span class="o">.</span><span class="n">RSnapshotOptions</span><span class="p">()</span>
        <span class="n">snapshotOptions</span><span class="o">.</span><span class="n">fLazy</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">for</span> <span class="n">df</span><span class="p">,</span> <span class="n">df_key</span> <span class="ow">in</span> <span class="p">[[</span><span class="n">ml_data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;signal&quot;</span><span class="p">],</span> <span class="p">[</span><span class="n">ml_data</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;background&quot;</span><span class="p">]]:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Book the training and testing events for </span><span class="si">{</span><span class="n">df_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># Reconstruct H_mass and angular variables for training.</span>
            <span class="n">df_charge</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">Filter</span><span class="p">(</span><span class="s2">&quot;(Electron_charge[0] + Electron_charge[1]) == 0 &quot;</span>\
                                  <span class="s2">&quot;&amp;&amp; (Muon_charge[0] + Muon_charge[1]) == 0&quot;</span><span class="p">,</span>
                                  <span class="s2">&quot;Two opposite charged electron and muon pairs&quot;</span><span class="p">)</span>
            <span class="n">df_reco</span> <span class="o">=</span> <span class="n">reco_define</span><span class="p">(</span><span class="n">df_charge</span><span class="p">)</span>
            <span class="c1"># Define other training variables</span>
            <span class="n">df_all</span> <span class="o">=</span> <span class="n">df_reco</span><span class="o">.</span><span class="n">Define</span><span class="p">(</span><span class="s2">&quot;Muon_pt_1&quot;</span><span class="p">,</span> <span class="s2">&quot;Muon_pt[0]&quot;</span><span class="p">)</span>\
                            <span class="o">.</span><span class="n">Define</span><span class="p">(</span><span class="s2">&quot;Muon_pt_2&quot;</span><span class="p">,</span> <span class="s2">&quot;Muon_pt[1]&quot;</span><span class="p">)</span>\
                            <span class="o">.</span><span class="n">Define</span><span class="p">(</span><span class="s2">&quot;Muon_mass_1&quot;</span><span class="p">,</span> <span class="s2">&quot;Muon_mass[0]&quot;</span><span class="p">)</span>\
                            <span class="o">.</span><span class="n">Define</span><span class="p">(</span><span class="s2">&quot;Muon_mass_2&quot;</span><span class="p">,</span> <span class="s2">&quot;Muon_mass[1]&quot;</span><span class="p">)</span>\
                            <span class="o">.</span><span class="n">Define</span><span class="p">(</span><span class="s2">&quot;Electron_mass_1&quot;</span><span class="p">,</span> <span class="s2">&quot;Electron_mass[0]&quot;</span><span class="p">)</span>\
                            <span class="o">.</span><span class="n">Define</span><span class="p">(</span><span class="s2">&quot;Electron_mass_2&quot;</span><span class="p">,</span> <span class="s2">&quot;Electron_mass[1]&quot;</span><span class="p">)</span>\
                            <span class="o">.</span><span class="n">Define</span><span class="p">(</span><span class="s2">&quot;Electron_pt_1&quot;</span><span class="p">,</span> <span class="s2">&quot;Electron_pt[0]&quot;</span><span class="p">)</span>\
                            <span class="o">.</span><span class="n">Define</span><span class="p">(</span><span class="s2">&quot;Electron_pt_2&quot;</span><span class="p">,</span> <span class="s2">&quot;Electron_pt[1]&quot;</span><span class="p">)</span>\
                            <span class="o">.</span><span class="n">Define</span><span class="p">(</span><span class="s2">&quot;Muon_eta_1&quot;</span><span class="p">,</span> <span class="s2">&quot;Muon_eta[0]&quot;</span><span class="p">)</span>\
                            <span class="o">.</span><span class="n">Define</span><span class="p">(</span><span class="s2">&quot;Muon_eta_2&quot;</span><span class="p">,</span> <span class="s2">&quot;Muon_eta[1]&quot;</span><span class="p">)</span>\
                            <span class="o">.</span><span class="n">Define</span><span class="p">(</span><span class="s2">&quot;Electron_eta_1&quot;</span><span class="p">,</span> <span class="s2">&quot;Electron_eta[0]&quot;</span><span class="p">)</span>\
                            <span class="o">.</span><span class="n">Define</span><span class="p">(</span><span class="s2">&quot;Electron_eta_2&quot;</span><span class="p">,</span> <span class="s2">&quot;Electron_eta[1]&quot;</span><span class="p">)</span>\
                            <span class="o">.</span><span class="n">Define</span><span class="p">(</span><span class="s2">&quot;Muon_phi_1&quot;</span><span class="p">,</span> <span class="s2">&quot;Muon_phi[0]&quot;</span><span class="p">)</span>\
                            <span class="o">.</span><span class="n">Define</span><span class="p">(</span><span class="s2">&quot;Muon_phi_2&quot;</span><span class="p">,</span> <span class="s2">&quot;Muon_phi[1]&quot;</span><span class="p">)</span>\
                            <span class="o">.</span><span class="n">Define</span><span class="p">(</span><span class="s2">&quot;Electron_phi_1&quot;</span><span class="p">,</span> <span class="s2">&quot;Electron_phi[0]&quot;</span><span class="p">)</span>\
                            <span class="o">.</span><span class="n">Define</span><span class="p">(</span><span class="s2">&quot;Electron_phi_2&quot;</span><span class="p">,</span> <span class="s2">&quot;Electron_phi[1]&quot;</span><span class="p">)</span>

            <span class="c1"># Save ml training datasets to file</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;train_</span><span class="si">{</span><span class="n">df_key</span><span class="si">}</span><span class="s2">.root&quot;</span>
            <span class="n">df_train</span> <span class="o">=</span> <span class="n">df_all</span><span class="o">.</span><span class="n">Snapshot</span><span class="p">(</span><span class="s2">&quot;Events&quot;</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">columns</span><span class="p">,</span> <span class="n">snapshotOptions</span><span class="p">)</span>
            <span class="n">list_df_train</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_train</span><span class="p">)</span>

    <span class="n">report_sig</span> <span class="o">=</span> <span class="n">list_df_train</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Filter</span><span class="p">(</span><span class="s2">&quot;H_mass &gt; 110 &amp;&amp; H_mass &lt;140&quot;</span><span class="p">,</span> <span class="s2">&quot;H_mass in [110, 140]&quot;</span><span class="p">)</span>\
                                 <span class="o">.</span><span class="n">Report</span><span class="p">()</span>
    <span class="n">report_bkg</span> <span class="o">=</span> <span class="n">list_df_train</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">Filter</span><span class="p">(</span><span class="s2">&quot;H_mass &gt; 110 &amp;&amp; H_mass &lt;140&quot;</span><span class="p">,</span> <span class="s2">&quot;H_mass in [110, 140]&quot;</span><span class="p">)</span>\
                                 <span class="o">.</span><span class="n">Report</span><span class="p">()</span>
    <span class="n">list_rep_train</span> <span class="o">=</span> <span class="p">[</span><span class="n">report_sig</span><span class="p">,</span> <span class="n">report_bkg</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">list_df_train</span><span class="p">,</span> <span class="n">list_rep_train</span></div>

<div class="viewcode-block" id="ml_preprocessing"><a class="viewcode-back" href="../../progetto.html#progetto.higgs_2e2mu.ml_preprocessing">[docs]</a><span class="k">def</span> <span class="nf">ml_preprocessing</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span> <span class="n">bkg</span><span class="p">,</span> <span class="n">branches</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Prepare the numpy arrays to be read by most ML tools.</span>

<span class="sd">    Reduce the amount of data to a fixed fraction of orginal dataset.</span>
<span class="sd">    (The fraction can be changed editing entries_frac variable)</span>
<span class="sd">    Perform data labeling, standardization and shuffling.</span>

<span class="sd">    The arrays are saved to local .npy files.</span>

<span class="sd">    Args:</span>
<span class="sd">        sig (numpy.ndarray): RDF converted to numpy array of &quot;sig&quot;.</span>
<span class="sd">        bkg (numpy.ndarray): RDF converted to numpy array of &quot;bkg&quot;.</span>
<span class="sd">        branches (list): list of branches name.</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple: standardized and shuffled data, data labels.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Convert inputs to format readable by machine learning tools</span>
    <span class="c1"># T is the transposed vector</span>
    <span class="n">x_sig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">sig</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">var</span><span class="p">)]</span> <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">branches</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
    <span class="n">x_bkg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">bkg</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">var</span><span class="p">)]</span> <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">branches</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
    <span class="c1"># Reduce the number of entries to save on disk keeping the original proportion</span>
    <span class="n">entries_frac</span> <span class="o">=</span> <span class="mf">0.5</span>
    <span class="n">nEntries_s</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">entries_frac</span> <span class="o">*</span> <span class="n">x_sig</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">nEntries_b</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">entries_frac</span> <span class="o">*</span> <span class="n">x_bkg</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">x_sig_red</span> <span class="o">=</span> <span class="n">x_sig</span><span class="p">[:</span><span class="n">nEntries_s</span><span class="p">]</span>
    <span class="n">x_bkg_red</span> <span class="o">=</span> <span class="n">x_bkg</span><span class="p">[:</span><span class="n">nEntries_b</span><span class="p">]</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">x_sig_red</span><span class="p">,</span> <span class="n">x_bkg_red</span><span class="p">])</span>
    <span class="c1"># Create labels</span>
    <span class="n">num_sig</span> <span class="o">=</span> <span class="n">x_sig_red</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">num_bkg</span> <span class="o">=</span> <span class="n">x_bkg_red</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">num_sig</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_bkg</span><span class="p">)])</span>
    <span class="c1"># Scaling data</span>
    <span class="n">sc</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
    <span class="n">x_sc</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

    <span class="n">x_sh</span><span class="p">,</span> <span class="n">y_sh</span> <span class="o">=</span> <span class="n">shuffle</span><span class="p">(</span><span class="n">x_sc</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&quot;x_sh_unbalanced.npy&quot;</span><span class="p">,</span> <span class="n">x_sh</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&quot;y_sh_unbalanced.npy&quot;</span><span class="p">,</span> <span class="n">y_sh</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">x_sh</span><span class="p">,</span> <span class="n">y_sh</span><span class="p">)</span></div>

<div class="viewcode-block" id="keras_model"><a class="viewcode-back" href="../../progetto.html#progetto.higgs_2e2mu.keras_model">[docs]</a><span class="k">def</span> <span class="nf">keras_model</span><span class="p">(</span><span class="n">in_dim</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Initialize, define and customize Keras model.</span>

<span class="sd">    Args:</span>
<span class="sd">        in_dim (int): input dimension to model.</span>

<span class="sd">    Returns:</span>
<span class="sd">        tensorflow.keras.models.Sequential: defined Keras model.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Definition of a costumized keras model</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">Sequential</span><span class="p">()</span>
    <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Dense</span><span class="p">(</span><span class="mi">24</span><span class="p">,</span> <span class="n">input_dim</span><span class="o">=</span><span class="n">in_dim</span><span class="p">,</span>
                    <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;relu&quot;</span><span class="p">))</span>
    <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Dense</span><span class="p">(</span><span class="mi">48</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;relu&quot;</span><span class="p">))</span>
    <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Dense</span><span class="p">(</span><span class="mi">24</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;relu&quot;</span><span class="p">))</span>
    <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.2</span><span class="p">))</span>
    <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Dense</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;sigmoid&quot;</span><span class="p">))</span>
    <span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="s2">&quot;binary_crossentropy&quot;</span><span class="p">,</span>
                  <span class="n">optimizer</span><span class="o">=</span><span class="n">SGD</span><span class="p">(</span><span class="n">lr</span><span class="o">=</span><span class="mf">0.01</span><span class="p">),</span>
                  <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;accuracy&quot;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">model</span></div>

<div class="viewcode-block" id="model_train"><a class="viewcode-back" href="../../progetto.html#progetto.higgs_2e2mu.model_train">[docs]</a><span class="k">def</span> <span class="nf">model_train</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">IN_DIM</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">X_val</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_val</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Try to load the already trained model of the chosen name, if not</span>
<span class="sd">    present initialize and train the default model, save and return it.</span>

<span class="sd">    WARNING: joblib is basically equivalet to Python pickle with an optimized handling</span>
<span class="sd">    for large numpy arrays, therefore it works only with matching python and sklearn</span>
<span class="sd">    versions. If different, the code is set to train again the models.</span>
<span class="sd">    Edit of the models characteristics is possible but only the N_EPOCHS is</span>
<span class="sd">    recorded in the saved file of the model</span>

<span class="sd">    Args:</span>
<span class="sd">        name (str): model name.</span>
<span class="sd">        IN_DIM (int): input dimension to model.</span>
<span class="sd">        X_train (numpy.ndarray): train dataset.</span>
<span class="sd">        X_val (numpy.ndarray): validation dataset.</span>
<span class="sd">        y_train (numpy.ndarray): training data labels.</span>
<span class="sd">        y_val (numpy.ndarray): validation data labels.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: dicionary containing model (and training history if keras).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">N_EPOCHS</span> <span class="o">=</span> <span class="mi">200</span>
    <span class="c1"># Series of specific instruction to train a keras model</span>
    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;k_model&quot;</span><span class="p">:</span>
        <span class="c1"># Check saved model</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Load saved model</span>
            <span class="n">k_model</span> <span class="o">=</span> <span class="n">load_model</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;k_model_ep</span><span class="si">{</span><span class="n">N_EPOCHS</span><span class="si">}</span><span class="s2">_nf</span><span class="si">{</span><span class="n">IN_DIM</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">k_history</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;k_history_ep</span><span class="si">{</span><span class="n">N_EPOCHS</span><span class="si">}</span><span class="s2">_nf</span><span class="si">{</span><span class="n">IN_DIM</span><span class="si">}</span><span class="s2">.npy&quot;</span><span class="p">,</span>
                                <span class="n">allow_pickle</span><span class="o">=</span><span class="s2">&quot;TRUE&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;model&quot;</span><span class="p">:</span><span class="n">k_model</span><span class="p">,</span> <span class="s2">&quot;history&quot;</span><span class="p">:</span><span class="n">k_history</span><span class="p">}</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">IOError</span><span class="p">,</span> <span class="ne">OSError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Something went wrong loading keras model or history: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># Train and save model to folder</span>
        <span class="c1"># Keras needs categorical labels (means one column per class &quot;0&quot; and &quot;1&quot;)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Keras model or history impossible to load. start training.&quot;</span><span class="p">)</span>
        <span class="n">Y_train_k</span> <span class="o">=</span> <span class="n">to_categorical</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span>
        <span class="n">Y_val_k</span> <span class="o">=</span> <span class="n">to_categorical</span><span class="p">(</span><span class="n">y_val</span><span class="p">)</span>
        <span class="n">k_model</span> <span class="o">=</span> <span class="n">keras_model</span><span class="p">(</span><span class="n">IN_DIM</span><span class="p">)</span>
        <span class="n">start1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">k_history</span> <span class="o">=</span> <span class="n">k_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">Y_train_k</span><span class="p">,</span>
                                <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">X_val</span><span class="p">,</span> <span class="n">Y_val_k</span><span class="p">),</span>
                                <span class="n">epochs</span><span class="o">=</span><span class="n">N_EPOCHS</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">64</span><span class="p">)</span>
        <span class="n">k_model</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;k_model_ep</span><span class="si">{</span><span class="n">N_EPOCHS</span><span class="si">}</span><span class="s2">_nf</span><span class="si">{</span><span class="n">IN_DIM</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;k_history_ep</span><span class="si">{</span><span class="n">N_EPOCHS</span><span class="si">}</span><span class="s2">_nf</span><span class="si">{</span><span class="n">IN_DIM</span><span class="si">}</span><span class="s2">.npy&quot;</span><span class="p">,</span> <span class="n">k_history</span><span class="o">.</span><span class="n">history</span><span class="p">)</span>
        <span class="n">k_history</span> <span class="o">=</span> <span class="n">k_history</span><span class="o">.</span><span class="n">history</span>
        <span class="n">stop1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Elapsed time training keras model:</span><span class="si">{</span><span class="n">stop1</span> <span class="o">-</span> <span class="n">start1</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;model&quot;</span><span class="p">:</span><span class="n">k_model</span><span class="p">,</span> <span class="s2">&quot;history&quot;</span><span class="p">:</span><span class="n">k_history</span><span class="p">}</span>
    <span class="c1"># The model is one of the sklearn package</span>
    <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">_nf</span><span class="si">{</span><span class="n">IN_DIM</span><span class="si">}</span><span class="s2">.pkl&quot;</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Load the pickle file</span>
            <span class="n">clf_load</span> <span class="o">=</span> <span class="n">joblib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">_nf</span><span class="si">{</span><span class="n">IN_DIM</span><span class="si">}</span><span class="s1">.pkl&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="n">clf_load</span><span class="p">}</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">IOError</span><span class="p">,</span> <span class="ne">OSError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Something went wrong loading </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">_nf</span><span class="si">{</span><span class="n">IN_DIM</span><span class="si">}</span><span class="s2">.pkl: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Local trained </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> impossible to load. Start training.&quot;</span><span class="p">)</span>
    <span class="c1"># If there are problems loading the local trained model or the model is yet</span>
    <span class="c1"># to be trained, it will be, and it will be saved locally.</span>
    <span class="n">start3</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;rf_model&quot;</span><span class="p">:</span>
        <span class="c1"># Supervised transformation based on random forests</span>
        <span class="n">rf</span> <span class="o">=</span> <span class="n">RandomForestClassifier</span><span class="p">(</span><span class="n">max_depth</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">n_estimators</span><span class="o">=</span><span class="n">IN_DIM</span><span class="p">)</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">rf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;mlp_model&quot;</span><span class="p">:</span>
        <span class="c1"># Multi-layer Perceptron model</span>
        <span class="n">mlp</span> <span class="o">=</span> <span class="n">MLPClassifier</span><span class="p">(</span><span class="n">hidden_layer_sizes</span><span class="o">=</span><span class="p">(</span><span class="n">IN_DIM</span><span class="o">+</span><span class="mi">5</span><span class="p">,),</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;tanh&#39;</span><span class="p">,</span>
                            <span class="n">batch_size</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">mlp</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;ada_model&quot;</span><span class="p">:</span>
        <span class="c1"># Ada boost decision tree classifier</span>
        <span class="n">bdt</span> <span class="o">=</span> <span class="n">AdaBoostClassifier</span><span class="p">(</span><span class="n">DecisionTreeClassifier</span><span class="p">(</span><span class="n">max_depth</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span>
                                 <span class="n">n_estimators</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">bdt</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;svc_model&quot;</span><span class="p">:</span>
        <span class="c1"># Linear Support Vector Classification</span>
        <span class="n">svc</span> <span class="o">=</span> <span class="n">SVC</span><span class="p">(</span><span class="n">C</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">kernel</span><span class="o">=</span><span class="s1">&#39;rbf&#39;</span><span class="p">,</span> <span class="n">probability</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">svc</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
    <span class="n">stop3</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Elapsed time training </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">stop3</span> <span class="o">-</span> <span class="n">start3</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
    <span class="c1"># Save model on disk</span>
    <span class="n">joblib</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">_nf</span><span class="si">{</span><span class="n">IN_DIM</span><span class="si">}</span><span class="s2">.pkl&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;model&quot;</span><span class="p">:</span><span class="n">model</span><span class="p">}</span></div>

<div class="viewcode-block" id="model_eval"><a class="viewcode-back" href="../../progetto.html#progetto.higgs_2e2mu.model_eval">[docs]</a><span class="k">def</span> <span class="nf">model_eval</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Evaluate the performaces of the classifier.</span>

<span class="sd">    ROC parameters are calculated: false positive rate (fpr)</span>
<span class="sd">                                   true positive rate (tpr)</span>
<span class="sd">                                   thresholds</span>
<span class="sd">                                   area under curve (AUC)</span>

<span class="sd">    Args:</span>
<span class="sd">        name (str): model name.</span>
<span class="sd">        model ([various types]): trained model, can be of different</span>
<span class="sd">                                 type depending on chosen model.</span>
<span class="sd">        X_test (numpy.ndarray): test dataset.</span>
<span class="sd">        y_test (numpy.ndarray): test data labels.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: dictionary containing the model ROC parameters</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;k_model&quot;</span><span class="p">:</span>
        <span class="c1"># Return the probability to belong to a class (2D array)</span>
        <span class="c1"># Takes only the column of the &quot;1&quot; class (containing the probability)</span>
        <span class="n">y_pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;rf_model&quot;</span><span class="p">,</span> <span class="s2">&quot;mlp_model&quot;</span><span class="p">,</span> <span class="s2">&quot;ada_model&quot;</span><span class="p">,</span> <span class="s2">&quot;svc_model&quot;</span><span class="p">]:</span>
        <span class="n">y_pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">]</span>

    <span class="c1"># Compute ROC curve and AUC</span>
    <span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">thresholds</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
    <span class="n">auc_model</span> <span class="o">=</span> <span class="n">auc</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;fpr&quot;</span><span class="p">:</span><span class="n">fpr</span><span class="p">,</span> <span class="s2">&quot;tpr&quot;</span><span class="p">:</span><span class="n">tpr</span><span class="p">,</span> <span class="s2">&quot;auc&quot;</span><span class="p">:</span><span class="n">auc_model</span><span class="p">,</span> <span class="s2">&quot;ths&quot;</span><span class="p">:</span><span class="n">thresholds</span><span class="p">}</span></div>

<div class="viewcode-block" id="ml_plot"><a class="viewcode-back" href="../../progetto.html#progetto.higgs_2e2mu.ml_plot">[docs]</a><span class="k">def</span> <span class="nf">ml_plot</span><span class="p">(</span><span class="n">models</span><span class="p">,</span> <span class="n">IN_DIM</span><span class="p">,</span> <span class="n">rep_train</span><span class="p">,</span> <span class="n">rep_higgs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Plot all the models and two points from two different filters</span>
<span class="sd">    of the std analysis are added.</span>

<span class="sd">    Args:</span>
<span class="sd">        models (dict): dictionary containing all models evalutation.</span>
<span class="sd">        IN_DIM (int): input dimension to model.</span>
<span class="sd">        rep_train (Report): Report of filter on Higgs mass only.</span>
<span class="sd">        rep_higgs (Report): Report of all filters and Higgs mass.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Here there is only the prefilter to ensure that the first two elements,</span>
    <span class="c1"># which are the ones that are used for all the reconstructed variables,</span>
    <span class="c1"># are of opposite charge, and the narrow filter on the Higgs mass</span>
    <span class="k">for</span> <span class="n">cut_sig</span><span class="p">,</span> <span class="n">cut_bkg</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">rep_train</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">rep_train</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="c1">#This works only because there is only registered 1 filter in the report</span>
        <span class="n">h_sig_eff</span> <span class="o">=</span> <span class="n">cut_sig</span><span class="o">.</span><span class="n">GetEff</span><span class="p">()</span><span class="o">*</span><span class="mf">0.01</span>
        <span class="n">h_bkg_rej</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">cut_bkg</span><span class="o">.</span><span class="n">GetEff</span><span class="p">()</span><span class="o">*</span><span class="mf">0.01</span>

    <span class="n">cut_eff_sig</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">cut_eff_bkg</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">cut_sig</span><span class="p">,</span> <span class="n">cut_bkg</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">rep_higgs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">rep_higgs</span><span class="p">[</span><span class="mi">1</span><span class="p">],):</span>
        <span class="n">cut_eff_sig</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cut_sig</span><span class="o">.</span><span class="n">GetEff</span><span class="p">()</span><span class="o">*</span><span class="mf">0.01</span><span class="p">)</span>
        <span class="n">cut_eff_bkg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cut_bkg</span><span class="o">.</span><span class="n">GetEff</span><span class="p">()</span><span class="o">*</span><span class="mf">0.01</span><span class="p">)</span>
    <span class="n">all_sig_eff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">cut_eff_sig</span><span class="p">)</span>
    <span class="n">all_bkg_rej</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">cut_eff_bkg</span><span class="p">)</span>

    <span class="c1"># Plot the ROC curves</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;k--&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">h_sig_eff</span><span class="p">,</span> <span class="n">h_bkg_rej</span><span class="p">,</span> <span class="s2">&quot;kx&quot;</span><span class="p">,</span>
             <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;std filter only on H mass:(</span><span class="si">{</span><span class="n">h_sig_eff</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">h_bkg_rej</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">all_sig_eff</span><span class="p">,</span> <span class="n">all_bkg_rej</span><span class="p">,</span> <span class="s2">&quot;r*&quot;</span><span class="p">,</span>
             <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;std all filters + H mass:(</span><span class="si">{</span><span class="n">all_sig_eff</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">all_bkg_rej</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">models</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">model</span><span class="p">[</span><span class="s2">&quot;tpr&quot;</span><span class="p">],</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">model</span><span class="p">[</span><span class="s2">&quot;fpr&quot;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1"> (area = </span><span class="si">{</span><span class="n">model</span><span class="p">[</span><span class="s2">&quot;auc&quot;</span><span class="p">]</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Signal efficiency&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Background rejection&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;ROC curve&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;best&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Roc_curve_nf</span><span class="si">{</span><span class="n">IN_DIM</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="mf">0.8</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;k--&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">h_sig_eff</span><span class="p">,</span> <span class="n">h_bkg_rej</span><span class="p">,</span> <span class="s2">&quot;kx&quot;</span><span class="p">,</span>
             <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;std filter only on H mass:(</span><span class="si">{</span><span class="n">h_sig_eff</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">h_bkg_rej</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">all_sig_eff</span><span class="p">,</span> <span class="n">all_bkg_rej</span><span class="p">,</span> <span class="s2">&quot;r*&quot;</span><span class="p">,</span>
             <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;std all filters + H mass:(</span><span class="si">{</span><span class="n">all_sig_eff</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">all_bkg_rej</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">models</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">model</span><span class="p">[</span><span class="s2">&quot;tpr&quot;</span><span class="p">],</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">model</span><span class="p">[</span><span class="s2">&quot;fpr&quot;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1"> (area = </span><span class="si">{</span><span class="n">model</span><span class="p">[</span><span class="s2">&quot;auc&quot;</span><span class="p">]</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Signal efficiency&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Background rejection&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;ROC curve (zoomed in at top right)&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Roc_curve_zoomed_nf</span><span class="si">{</span><span class="n">IN_DIM</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Plot loss curve for keras model</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">models</span><span class="p">[</span><span class="s2">&quot;k_model&quot;</span><span class="p">][</span><span class="s2">&quot;history&quot;</span><span class="p">][</span><span class="s2">&quot;loss&quot;</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">models</span><span class="p">[</span><span class="s2">&quot;k_model&quot;</span><span class="p">][</span><span class="s2">&quot;history&quot;</span><span class="p">][</span><span class="s2">&quot;val_loss&quot;</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Keras Model loss&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Loss&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Epoch&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s2">&quot;Train&quot;</span><span class="p">,</span> <span class="s2">&quot;Test&quot;</span><span class="p">],</span> <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper left&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;loss_curve_nf</span><span class="si">{</span><span class="n">IN_DIM</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="ml_retrieve"><a class="viewcode-back" href="../../progetto.html#progetto.higgs_2e2mu.ml_retrieve">[docs]</a><span class="k">def</span> <span class="nf">ml_retrieve</span><span class="p">(</span><span class="n">df_train</span><span class="p">,</span> <span class="n">rep_train</span><span class="p">,</span> <span class="n">rep_higgs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Retrieve the dataset to train a ML or a DNN model,</span>
<span class="sd">    perform the training and testing and plot them in a ROC curve for</span>
<span class="sd">    comparison.</span>
<span class="sd">    The code is set to search the trained models locally and load them,</span>
<span class="sd">    to perform the training remove the relative file/dir from the</span>
<span class="sd">    working drectory.</span>
<span class="sd">    The number of given events, features and ephocs (for the keras model)</span>
<span class="sd">    can be set. (Instant unless local trained model is found)</span>
<span class="sd">    Warning: In ml_request: ml_var are the features available, they can be</span>
<span class="sd">    selected but must always be the same size of IN_DIM.</span>
<span class="sd">    Hence if any change is applied over the dataset, make sure to either</span>
<span class="sd">    remove or rename the local file when necessary</span>

<span class="sd">    Args:</span>
<span class="sd">        df_train (list): list of training RDF.</span>
<span class="sd">        rep_train (Report): Report of filter on Higgs mass only.</span>
<span class="sd">        rep_higgs (Report): Report of all filters and Higgs mass.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">N_EVENTS</span> <span class="o">=</span> <span class="mi">100000</span> <span class="c1"># Max available 134618 (update if edit entries_frac in ml_prepr)</span>
    <span class="c1"># N_COLUMNS = 22 # Max available 22</span>
    <span class="n">IN_DIM</span> <span class="o">=</span> <span class="mi">22</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># From now on all variables &gt;1D have capital letter</span>
        <span class="n">X_sh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;x_sh_unbalanced.npy&quot;</span><span class="p">)</span>
        <span class="n">y_sh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;y_sh_unbalanced.npy&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">IOError</span><span class="p">,</span> <span class="ne">OSError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Something went wrong loading .npy file: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Read data from ROOT files, convert to .npy and prepare for ML.&quot;</span>
                    <span class="s2">&quot;This trigger the event loop if not done before&quot;</span><span class="p">)</span>
        <span class="c1"># Read data from ROOT files, trigger event loop if not done before</span>
        <span class="n">list_branches</span> <span class="o">=</span> <span class="n">df_train</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">GetColumnNames</span><span class="p">()</span>
        <span class="n">data_sig</span> <span class="o">=</span> <span class="n">df_train</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">AsNumpy</span><span class="p">()</span>
        <span class="n">data_bkg</span> <span class="o">=</span> <span class="n">df_train</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">AsNumpy</span><span class="p">()</span>
        <span class="c1"># The arrays are now normalized and shuffled, and their file is saved</span>
        <span class="n">X_sh</span><span class="p">,</span> <span class="n">y_sh</span> <span class="o">=</span> <span class="n">ml_preprocessing</span><span class="p">(</span><span class="n">data_sig</span><span class="p">,</span> <span class="n">data_bkg</span><span class="p">,</span> <span class="n">list_branches</span><span class="p">)</span>
    <span class="c1"># To have an idea of the distribution in variance of the data, the PCA is given.</span>
    <span class="n">pca</span> <span class="o">=</span> <span class="n">PCA</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">X_pca</span> <span class="o">=</span> <span class="n">pca</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_sh</span><span class="p">)</span>
    <span class="c1"># Quick plot</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">target_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;signal&quot;</span><span class="p">,</span> <span class="s2">&quot;background&quot;</span><span class="p">]</span>
    <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;navy&quot;</span><span class="p">,</span> <span class="s2">&quot;darkorange&quot;</span><span class="p">]</span>
    <span class="n">lw</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="k">for</span> <span class="n">color</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">target_name</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">colors</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">target_names</span><span class="p">):</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">X_pca</span><span class="p">[</span><span class="n">y_sh</span> <span class="o">==</span> <span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">X_pca</span><span class="p">[</span><span class="n">y_sh</span> <span class="o">==</span> <span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=.</span><span class="mi">8</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="n">lw</span><span class="p">,</span>
                    <span class="n">label</span><span class="o">=</span><span class="n">target_name</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">,</span> <span class="n">shadow</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">scatterpoints</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;PCA of dataset&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;PCA&quot;</span><span class="p">)</span>

    <span class="c1">#If the entries_frac in ml_preprocessing has been changed enable this to see</span>
    <span class="c1"># the new availabe dimension of the dataset</span>
    <span class="c1"># print(X_sh.shape, y_sh.shape)</span>

    <span class="c1"># Selection of the events and variables, the sliced columns Must be of</span>
    <span class="c1"># IN_DIM size</span>
    <span class="n">X_sh</span> <span class="o">=</span> <span class="n">X_sh</span><span class="p">[:</span><span class="n">N_EVENTS</span><span class="p">,</span> <span class="p">:]</span>
    <span class="n">y_sh</span> <span class="o">=</span> <span class="n">y_sh</span><span class="p">[:</span><span class="n">N_EVENTS</span><span class="p">]</span>

    <span class="c1"># Prepare train and test set, all models will need this, and validation set for keras</span>
    <span class="n">X_batch</span><span class="p">,</span> <span class="n">X_val</span><span class="p">,</span> <span class="n">y_batch</span><span class="p">,</span> <span class="n">y_val</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">X_sh</span><span class="p">,</span> <span class="n">y_sh</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
    <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">X_batch</span><span class="p">,</span> <span class="n">y_batch</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

    <span class="c1">#Dictionary of the used models</span>
    <span class="n">models_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;k_model&quot;</span><span class="p">:{},</span> <span class="s2">&quot;rf_model&quot;</span><span class="p">:{},</span> <span class="s2">&quot;mlp_model&quot;</span><span class="p">:{},</span> <span class="s2">&quot;ada_model&quot;</span><span class="p">:{},</span> <span class="s2">&quot;svc_model&quot;</span><span class="p">:{}}</span>
    <span class="c1"># Here the ML models and DNNs are trained, fitted and evaluated, then are ready to be plotted</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">models_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">models_dict</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">model_train</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">IN_DIM</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">X_val</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_val</span><span class="p">)</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">models_dict</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;model&quot;</span><span class="p">]</span>
        <span class="n">eval_dict</span> <span class="o">=</span> <span class="n">model_eval</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>
        <span class="n">models_dict</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">eval_dict</span><span class="p">)</span>

    <span class="c1"># Plot all the models</span>
    <span class="n">ml_plot</span><span class="p">(</span><span class="n">models_dict</span><span class="p">,</span> <span class="n">IN_DIM</span><span class="p">,</span> <span class="n">rep_train</span><span class="p">,</span> <span class="n">rep_higgs</span><span class="p">)</span></div>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>

    <span class="c1"># Monitor of the code run time</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="c1"># Set the standard mode of analysis</span>
    <span class="n">perform_std</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># Possible options for different analysis</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="n">_description</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-l&quot;</span><span class="p">,</span> <span class="s2">&quot;--local&quot;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;perform analysis on local dataframe,&quot;</span>
                        <span class="s2">&quot; download of the request data if not present&quot;</span><span class="p">,</span>
                        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">)</span>
    <span class="n">group</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_mutually_exclusive_group</span><span class="p">()</span>
    <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-p&quot;</span><span class="p">,</span> <span class="s2">&quot;--preliminar&quot;</span><span class="p">,</span>
                       <span class="n">help</span><span class="o">=</span><span class="s2">&quot;perform only preliminar analysis&quot;</span><span class="p">,</span>
                       <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">)</span>
    <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-b&quot;</span><span class="p">,</span> <span class="s2">&quot;--both&quot;</span><span class="p">,</span>
                       <span class="n">help</span><span class="o">=</span><span class="s2">&quot;perform also preliminar analysis&quot;</span><span class="p">,</span>
                       <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>

    <span class="c1"># Check the chosen argparse options</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">preliminar</span> <span class="ow">or</span> <span class="n">args</span><span class="o">.</span><span class="n">both</span><span class="p">:</span>
        <span class="c1"># In both cases we need the preliminary requests</span>
        <span class="n">key_df_prel</span><span class="p">,</span> <span class="n">branches_prel</span><span class="p">,</span> <span class="n">histos_prel</span> <span class="o">=</span> <span class="n">preliminar_request</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">local</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">preliminar</span><span class="p">:</span>
            <span class="c1"># Standard analysis is excluded</span>
            <span class="n">perform_std</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;You have disabled standard analysis&quot;</span><span class="p">)</span>
            <span class="c1"># There are no other requests, event loop can be triggered</span>
            <span class="n">preliminar_retrieve</span><span class="p">(</span><span class="n">key_df_prel</span><span class="p">,</span> <span class="n">branches_prel</span><span class="p">,</span> <span class="n">histos_prel</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;It will pass to the requests for standard analysis&quot;</span><span class="p">)</span>
            <span class="k">pass</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="k">if</span> <span class="n">perform_std</span><span class="p">:</span>
        <span class="c1"># Standard analysis</span>
        <span class="n">filter_dicts</span><span class="p">,</span> <span class="n">h_higgs</span><span class="p">,</span> <span class="n">rep_higgs</span><span class="p">,</span> <span class="n">df_ml</span><span class="p">,</span> <span class="n">ang_dict</span> <span class="o">=</span> <span class="n">standard_request</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">local</span><span class="p">)</span>
        <span class="n">ml_req_df</span><span class="p">,</span> <span class="n">ml_req_rep</span> <span class="o">=</span> <span class="n">ml_request</span><span class="p">(</span><span class="n">df_ml</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">both</span><span class="p">:</span>
            <span class="c1"># Preliminary requests done. Let&#39;s go to the retrieving part</span>
            <span class="n">preliminar_retrieve</span><span class="p">(</span><span class="n">key_df_prel</span><span class="p">,</span> <span class="n">branches_prel</span><span class="p">,</span> <span class="n">histos_prel</span><span class="p">)</span>
            <span class="n">standard_retrieve</span><span class="p">(</span><span class="n">filter_dicts</span><span class="p">,</span> <span class="n">h_higgs</span><span class="p">,</span> <span class="n">rep_higgs</span><span class="p">,</span> <span class="n">ang_dict</span><span class="p">)</span>
            <span class="c1"># ml_retrieve(ml_req_df, ml_req_rep, rep_higgs)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">standard_retrieve</span><span class="p">(</span><span class="n">filter_dicts</span><span class="p">,</span> <span class="n">h_higgs</span><span class="p">,</span> <span class="n">rep_higgs</span><span class="p">,</span> <span class="n">ang_dict</span><span class="p">)</span>
            <span class="c1"># ml_retrieve(ml_req_df, ml_req_rep, rep_higgs)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;You have chosen to perform only standard analysis&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="n">stop</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;elapsed code time: </span><span class="si">{</span><span class="n">stop</span> <span class="o">-</span> <span class="n">start</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2020, Silvia Benegiano

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>